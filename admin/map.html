<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DrainTrack - Interactive Map</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.css" rel="stylesheet">
  <!-- Leaflet MarkerCluster CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" rel="stylesheet">
  
  <!-- Unified Design System CSS -->
  <link href="../css/map-common.css" rel="stylesheet">
  
  <style>
    /* Admin-specific additional styles */
    .admin-features {
      background: linear-gradient(135deg, #e3f2fd, #bbdefb);
      border: 1px solid var(--primary-color);
      border-radius: var(--border-radius);
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .image-gallery-container {
      position: relative;
      background: #f8f9fa;
      border-radius: var(--border-radius);
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .image-gallery-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid #e9ecef;
    }

    .main-image-container {
      position: relative;
      width: 100%;
      height: 300px;
      border-radius: var(--border-radius-sm);
      overflow: hidden;
      background: #e9ecef;
      margin-bottom: 1rem;
      box-shadow: var(--shadow-md);
    }

    .main-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      cursor: pointer;
      transition: var(--transition-normal);
    }

    .main-image:hover {
      transform: scale(1.02);
    }

    .image-navigation {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      border: none;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--transition-normal);
      z-index: 10;
    }

    .image-navigation:hover {
      background: rgba(0,0,0,0.9);
      transform: translateY(-50%) scale(1.1);
    }

    .nav-prev {
      left: 10px;
    }

    .nav-next {
      right: 10px;
    }

    .thumbnail-strip {
      display: flex;
      gap: 0.5rem;
      overflow-x: auto;
      padding: 0.5rem 0;
    }

    .thumbnail-item {
      position: relative;
      flex-shrink: 0;
      width: 80px;
      height: 60px;
      border-radius: var(--border-radius-sm);
      overflow: hidden;
      cursor: pointer;
      border: 2px solid transparent;
      transition: var(--transition-normal);
    }

    .thumbnail-item:hover {
      border-color: var(--primary-color);
      transform: translateY(-2px);
    }

    .thumbnail-item.active {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
    }

    .validation-feedback {
      display: block;
      width: 100%;
      margin-top: 0.25rem;
      font-size: 0.875em;
    }

    .is-valid {
      border-color: #28a745 !important;
    }

    .is-invalid {
      border-color: #dc3545 !important;
    }

    .valid-feedback {
      color: #28a745;
    }

    .invalid-feedback {
      color: #dc3545;
    }

    #point-id {
      text-transform: uppercase;
    }

    .existing-images-grid .position-relative:hover .btn-danger {
      opacity: 1;
    }

    .existing-images-grid .btn-danger {
      opacity: 0.7;
      transition: var(--transition-normal);
    }

    .existing-images-grid .img-thumbnail {
      transition: var(--transition-normal);
    }

    .existing-images-grid .position-relative:hover .img-thumbnail {
      transform: scale(1.05);
    }
  </style>

<script>

  // Global variables for authentication
  let currentUser = null;

  // Initialize page with authentication
  document.addEventListener('DOMContentLoaded', function() {
    checkAuthentication();
  });

  /**
   * Check if user is authenticated and has appropriate role
   */
  async function checkAuthentication() {
    try {
      const response = await fetch('../api/session-check.php');
      const result = await response.json();
      
      if (result.success && result.authenticated) {
        // Check if user has appropriate role for map access
        const allowedRoles = ['Admin', 'Inspector', 'Operator'];
        if (!allowedRoles.includes(result.user.role)) {
          showSecurityNotification('Access denied. You do not have permission to access the interactive map.', 'danger');
          setTimeout(() => {
            window.location.href = '../login.html?unauthorized=1';
          }, 2000);
          return;
        }
        
        currentUser = result.user;
        updateUserInfo(currentUser);
        hideAuthLoadingOverlay();
        
        // Continue with original initialization
        initializeMapAfterAuth();
      } else {
        // Redirect to login page
        window.location.href = '../login.html?unauthorized=1';
      }
    } catch (error) {
      console.error('Authentication check failed:', error);
      showSecurityNotification('Authentication check failed. Redirecting to login...', 'danger');
      setTimeout(() => {
        window.location.href = '../login.html?error=1';
      }, 2000);
    }
  }

  /**
   * Update user info in the navigation
   */
  function updateUserInfo(user) {
    const userDropdown = document.getElementById('userDropdown');
    if (userDropdown) {
      userDropdown.innerHTML = `
        <i class="fas fa-user-circle me-1"></i> ${user.name || user.first_name + ' ' + user.last_name}
      `;
    }
  }

  /**
   * Hide the authentication loading overlay
   */
  function hideAuthLoadingOverlay() {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) {
      overlay.style.opacity = '0';
      setTimeout(() => {
        overlay.style.display = 'none';
      }, 300);
    }
  }

  /**
   * Initialize map after successful authentication
   */
  function initializeMapAfterAuth() {
    // Original map initialization code will be called here
    // This replaces the original DOMContentLoaded initialization
    showLoading(true);

    // Initialize components in order
    initializeMap();
    initializeControlPanel();
    setupEventListeners();
    injectEnhancedSearchCSS();
    injectImageGalleryCSS();

    // Load data
    Promise.all([
      fetchDrainageData(),
      fetchFloodProneAreas(),
      fetchAndRenderDrainageLines(),
      loadUsers(),
    ])
      .then(() => {
        showLoading(false);
        showNotification("Map loaded successfully", "success");

        // Initialize search dropdown with all data after loading
        if (allDrainageData.length > 0) {
          populateSearchDropdown(allDrainageData);
        }
      })
      .catch((error) => {
        console.error("Error initializing application:", error);
        showLoading(false);
        showNotification("Error loading map data", "danger");
      });
  }



  /**
   * Show security-related notifications
   */
  function showSecurityNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show notification`;
    notification.innerHTML = `
      <i class="fas fa-${getSecurityNotificationIcon(type)} me-2"></i>
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    setTimeout(() => {
      if (notification.parentNode) notification.remove();
    }, 5000);
  }

  function getSecurityNotificationIcon(type) {
    const icons = {
      success: "check-circle",
      danger: "exclamation-triangle",
      warning: "exclamation-triangle",
      info: "info-circle",
    };
    return icons[type] || "info-circle";
  } 

  function injectImageGalleryCSS() {
const imageGalleryCSS = `
  /* Enhanced Image Gallery Styles */
  .image-gallery-container {
    position: relative;
    background: #f8f9fa;
    border-radius: 15px;
    padding: 1rem;
    margin-bottom: 1rem;
  }

  .image-gallery-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #e9ecef;
  }

  .image-counter {
    font-size: 0.9rem;
    color: #6c757d;
    font-weight: 500;
  }

  .gallery-controls {
    display: flex;
    gap: 0.5rem;
  }

  .gallery-btn {
    padding: 0.25rem 0.5rem;
    border: none;
    border-radius: 6px;
    background: #6c757d;
    color: white;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .gallery-btn:hover {
    background: #495057;
    transform: translateY(-1px);
  }

  .gallery-btn.danger {
    background: #dc3545;
  }

  .gallery-btn.danger:hover {
    background: #c82333;
  }

  .main-image-container {
    position: relative;
    width: 100%;
    height: 300px;
    border-radius: 10px;
    overflow: hidden;
    background: #e9ecef;
    margin-bottom: 1rem;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }

  .main-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    cursor: pointer;
    transition: transform 0.3s ease;
  }

  .main-image:hover {
    transform: scale(1.02);
  }

  .image-navigation {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0,0,0,0.7);
    color: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 10;
  }

  .image-navigation:hover {
    background: rgba(0,0,0,0.9);
    transform: translateY(-50%) scale(1.1);
  }

  .nav-prev {
    left: 10px;
  }

  .nav-next {
    right: 10px;
  }

  .image-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.8));
    color: white;
    padding: 1rem;
    font-size: 0.9rem;
  }

  .image-filename {
    font-weight: 500;
    margin-bottom: 0.25rem;
  }

  .image-date {
    font-size: 0.8rem;
    opacity: 0.8;
  }

  .thumbnail-strip {
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    padding: 0.5rem 0;
    scrollbar-width: thin;
    scrollbar-color: #6c757d #e9ecef;
  }

  .thumbnail-strip::-webkit-scrollbar {
    height: 6px;
  }

  .thumbnail-strip::-webkit-scrollbar-track {
    background: #e9ecef;
    border-radius: 3px;
  }

  .thumbnail-strip::-webkit-scrollbar-thumb {
    background: #6c757d;
    border-radius: 3px;
  }

  .thumbnail-item {
    position: relative;
    flex-shrink: 0;
    width: 80px;
    height: 60px;
    border-radius: 6px;
    overflow: hidden;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.3s ease;
  }

  .thumbnail-item:hover {
    border-color: #007bff;
    transform: translateY(-2px);
  }

  .thumbnail-item.active {
    border-color: #007bff;
    box-shadow: 0 0 0 2px rgba(0,123,255,0.25);
  }

  .thumbnail-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .thumbnail-delete {
    position: absolute;
    top: 2px;
    right: 2px;
    background: rgba(220,53,69,0.9);
    color: white;
    border: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    font-size: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .thumbnail-item:hover .thumbnail-delete {
    opacity: 1;
  }

  .thumbnail-delete:hover {
    background: #dc3545;
    transform: scale(1.1);
  }

  .no-images-placeholder {
    text-align: center;
    padding: 3rem 1rem;
    color: #6c757d;
  }

  .no-images-placeholder i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  /* Fullscreen Modal */
  .image-fullscreen-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.95);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
  }

  .image-fullscreen-modal.show {
    opacity: 1;
    visibility: visible;
  }

  .fullscreen-image {
    max-width: 90%;
    max-height: 90%;
    object-fit: contain;
    border-radius: 10px;
    box-shadow: 0 0 50px rgba(0,0,0,0.5);
  }

  .fullscreen-close {
    position: absolute;
    top: 20px;
    right: 20px;
    background: rgba(255,255,255,0.2);
    color: white;
    border: none;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .fullscreen-close:hover {
    background: rgba(255,255,255,0.3);
    transform: scale(1.1);
  }

  .fullscreen-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255,255,255,0.2);
    color: white;
    border: none;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    font-size: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .fullscreen-nav:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-50%) scale(1.1);
  }

  .fullscreen-prev {
    left: 30px;
  }

  .fullscreen-next {
    right: 30px;
  }

  .fullscreen-info {
    position: absolute;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.7);
    color: white;
    padding: 1rem 2rem;
    border-radius: 25px;
    text-align: center;
  }

  @media (max-width: 768px) {
    .main-image-container {
      height: 250px;
    }
    
    .thumbnail-item {
      width: 60px;
      height: 45px;
    }
    
    .image-navigation {
      width: 35px;
      height: 35px;
      font-size: 0.9rem;
    }
    
    .fullscreen-nav {
      width: 50px;
      height: 50px;
      font-size: 1.2rem;
    }
  }
`;

const style = document.createElement("style");
style.textContent = imageGalleryCSS;
document.head.appendChild(style);
}
</script>
</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-expand-lg navbar-dark admin">
  <div class="container-fluid">
    <a class="navbar-brand" href="admin.html">
      <i class="fas fa-water"></i>
      DrainTrack
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav me-auto">
        <li class="nav-item">
          <a class="nav-link" href="admin.html">
            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="map.html">
            <i class="fas fa-map me-1"></i>Interactive Map
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="flood-report.html">
            <i class="fas fa-exclamation-triangle me-1"></i>Flood Reports
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="maintanance-inspection.html">
            <i class="fas fa-tools me-1"></i>Management
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="user.html">
            <i class="fas fa-users me-1"></i>User Management
          </a>
        </li>
      </ul>
      <div class="ms-3">
        <div class="dropdown">
          <a class="btn btn-outline-light dropdown-toggle" href="#" role="button" id="userDropdown" data-bs-toggle="dropdown">
            <i class="fas fa-user-circle me-1"></i> Admin
          </a>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>Profile</a></li>
            <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Settings</a></li>
            <li><hr class="dropdown-divider"></li>
            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</nav>

<div class="full-screen-container">
  <div class="map-container">
    <!-- Map Element -->
    <div id="map"></div>
    
   <div class="control-panel" id="controlPanel">
<div class="control-panel-header admin">
  <h4><i class="fas fa-sliders-h me-2"></i>Map Controls</h4>
  <button type="button" class="panel-toggle admin" id="panelToggle" title="Toggle Control Panel">
    <i class="fas fa-chevron-left" id="toggleIcon"></i>
  </button>
</div>

<div class="control-panel-body">
  <!-- Your existing control panel content stays the same -->
  <!-- Search -->
  <!-- Enhanced Search Container -->
<div class="search-container">
<i class="fas fa-search search-icon"></i>
<input type="text" class="form-control" id="search-input" placeholder="Search drainage points, locations...">
<button class="clear-search" id="clear-search-btn" title="Clear search">
  <i class="fas fa-times"></i>
</button>
<div class="search-dropdown" id="search-dropdown">
  <!-- Dropdown items will be populated here -->
</div>
</div>
  <!-- Quick Filters -->
  <div class="filter-section">
    <h5><i class="fas fa-filter me-2"></i>Quick Filters</h5>
    
    <div class="mb-3">
      <label class="form-label mb-2">Drainage Type</label>
      <div class="filter-badges">
        <span class="filter-badge admin active" data-filter="all" data-type="type">All Types</span>
        <span class="filter-badge admin" data-filter="concrete" data-type="type">Concrete</span>
        <span class="filter-badge admin" data-filter="earth" data-type="type">Earth</span>
        <span class="filter-badge admin" data-filter="box-culvert" data-type="type">Box Culvert</span>
        <span class="filter-badge admin" data-filter="pipe" data-type="type">Pipe</span>
      </div>
    </div>
    
    <div class="mb-3">
      <label class="form-label mb-2">Condition Status</label>
      <div class="filter-badges">
        <span class="filter-badge admin active" data-filter="all" data-type="status">All Status</span>
        <span class="filter-badge admin" data-filter="good" data-type="status">Good</span>
        <span class="filter-badge admin" data-filter="needs-maintenance" data-type="status">Maintenance</span>
        <span class="filter-badge admin" data-filter="critical" data-type="status">Critical</span>
      </div>
    </div>
    
    <div class="range-container">
      <label class="form-label mb-2">Depth Range</label>
      <div class="d-flex align-items-center">
        <input type="range" class="form-range" id="depth-range" min="0" max="10" step="0.5" value="10" title="Select maximum depth" placeholder="Select depth range">
        <span class="range-value ms-2" id="depth-value">0-10m</span>
      </div>
    </div>
  </div>
  
  <!-- Legend -->
  <div class="legend">
    <h5><i class="fas fa-info-circle me-2"></i>Legend</h5>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #28a745;"></div>
      <span>Good Condition</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #ffc107;"></div>
      <span>Needs Maintenance</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #dc3545;"></div>
      <span>Critical Condition</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #17a2b8;"></div>
      <span>Flood-prone Area</span>
    </div>
  </div>
  
  <!-- Panel Control Buttons -->
  <div class="mt-3">
    <div class="d-grid gap-2">
      <button class="btn btn-outline-secondary btn-sm" onclick="closeControlPanel()">
        <i class="fas fa-times me-1"></i> Close Panel
      </button>
      <button class="btn btn-outline-primary btn-sm" onclick="toggleControlPanel()">
        <i class="fas fa-expand-arrows-alt me-1"></i> Toggle Panel
      </button>
    </div>
  </div>
</div>
</div>
        
        
      </div>
    </div>
    
    <!-- Map Controls -->
    <div class="map-controls">
      <button class="map-control-btn" id="zoom-in-btn" title="Zoom In">
        <i class="fas fa-plus"></i>
      </button>
      <button class="map-control-btn" id="zoom-out-btn" title="Zoom Out">
        <i class="fas fa-minus"></i>
      </button>
      <button class="map-control-btn" id="locate-me-btn" title="My Location">
        <i class="fas fa-location-arrow"></i>
      </button>
      <button class="map-control-btn" id="full-extent-btn" title="Full Extent">
        <i class="fas fa-expand"></i>
      </button>
      <button class="map-control-btn" id="toggle-layers-btn" title="Layer Control">
        <i class="fas fa-layer-group"></i>
      </button>
    </div>
    
    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="action-btn btn-danger-custom flood-report-btn">
        <i class="fas fa-exclamation-triangle"></i>
        Report Flood
      </button>
      <button class="action-btn btn-secondary-custom" id="export-btn">
        <i class="fas fa-download"></i>
        Export Data
      </button>
      <button class="action-btn btn-admin" id="add-point-btn">
        <i class="fas fa-plus"></i>
        Add Point
      </button>
    </div>
  </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loading-overlay">
  <div class="spinner-container">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <div class="mt-3 fw-bold">Loading map data...</div>
  </div>
</div>

<!-- Add Point Modal -->
<div class="modal fade" id="addPointModal" tabindex="-1" aria-labelledby="addPointModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header admin">
        <h5 class="modal-title" id="addPointModalLabel">
          <i class="fas fa-plus-circle me-2"></i>Add New Drainage Point
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="add-point-form">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="point-id" class="form-label">
                  Point ID *
                  <i class="fas fa-info-circle ms-1" title="Enter a unique identifier for this drainage point"></i>
                </label>
                <input type="text" class="form-control" id="point-id" required placeholder="e.g., MAIN01, PHL4, BB8">
                <div class="form-text">
                  <i class="fas fa-lightbulb me-1"></i>
                  Use a unique alphanumeric ID (letters, numbers, no spaces)
                </div>
                <div class="invalid-feedback" id="point-id-feedback">
                  This ID already exists or is invalid.
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="point-name" class="form-label">Point Name *</label>
                <input type="text" class="form-control" id="point-name" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="point-type" class="form-label">Drainage Type *</label>
                <select class="form-select" id="point-type" required>
                  <option value="">Select type</option>
                  <option value="Concrete Drain">Concrete Drain</option>
                  <option value="Earth Drain">Earth Drain</option>
                  <option value="Box Culvert">Box Culvert</option>
                  <option value="Pipe Drain">Pipe Drain</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label for="point-depth" class="form-label">Depth (m)</label>
                <input type="number" class="form-control" id="point-depth" step="0.1" min="0">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="point-status" class="form-label">Status *</label>
                <select class="form-select" id="point-status" required>
                  <option value="Good">Good</option>
                  <option value="Needs Maintenance">Needs Maintenance</option>
                  <option value="Critical">Critical</option>
                </select>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="point-il" class="form-label">Invert Level</label>
                <input type="text" class="form-control" id="point-il">
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label for="point-rl" class="form-label">Reduced Level</label>
                <input type="text" class="form-control" id="point-rl"
                       placeholder="e.g., 17.7m">
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="point-coordinates" class="form-label">Coordinates *</label>
            <div class="input-group">
              <input type="text" class="form-control" id="point-lat" placeholder="Latitude" readonly>
              <input type="text" class="form-control" id="point-lng" placeholder="Longitude" readonly>
              <button class="btn btn-outline-primary" type="button" id="pick-location-btn">
                <i class="fas fa-map-marker-alt"></i> Pick Location
              </button>
            </div>
            <div class="form-text">Click "Pick Location" to select coordinates on the map</div>
          </div>
          
          <div class="mb-3">
            <label for="point-description" class="form-label">Description</label>
            <textarea class="form-control" id="point-description" rows="3" placeholder="Enter additional details about this drainage point..."></textarea>
          </div>
          
          <div class="mb-3">
            <label for="point-images" class="form-label">Upload Images</label>
            <input type="file" class="form-control" id="point-images" multiple accept="image/*">
            <div class="form-text">You can select multiple images (JPG, PNG)</div>
          </div>
          <div class="alert alert-info d-none" id="id-validation-alert">
            <i class="fas fa-info-circle me-2"></i>
            <span id="id-validation-message">Enter an ID to check availability</span>
          </div>
        </form>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-point-btn">
          <i class="fas fa-save me-1"></i>Save Point
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Flood Report Modal -->
<div class="modal fade" id="floodReportModal" tabindex="-1" aria-labelledby="floodReportModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-danger">
        <h5 class="modal-title" id="floodReportModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>Report Flooding Incident
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <i class="fas fa-info-circle me-2"></i>
          Please provide accurate details to help emergency responders assess the situation quickly.
        </div>
        <form id="flood-report-form">
          <div class="mb-3">
            <label for="flood-location-input" class="form-label">Flood Location *</label>
            <div class="input-group">
              <input type="text" class="form-control" id="flood-location-input" placeholder="Enter location description or address" required>
              <button class="btn btn-outline-primary" type="button" id="flood-pick-location-btn">
                <i class="fas fa-map-marker-alt"></i> Pick on Map
              </button>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label for="flood-severity" class="form-label">Flood Severity *</label>
                <select class="form-select" id="flood-severity" required>
                  <option value="">Select severity level</option>
                  <option value="Minor">Minor - Small puddles, passable</option>
                  <option value="Moderate">Moderate - Road partially flooded</option>
                  <option value="Severe">Severe - Road impassable</option>
                  <option value="Extreme">Extreme - Property flooding</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label for="flood-water-depth" class="form-label">Water Depth (cm)</label>
                <input type="number" class="form-control" id="flood-water-depth" min="0" step="1" placeholder="Estimated depth">
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <label for="flood-description" class="form-label">Detailed Description *</label>
            <textarea class="form-control" id="flood-description" rows="4" required placeholder="Describe the flooding situation, affected areas, and any immediate dangers..."></textarea>
          </div>
          
          <div class="mb-3">
            <label for="reporter-contact" class="form-label">Your Contact Information</label>
            <input type="text" class="form-control" id="reporter-contact" placeholder="Phone number or email (optional)">
            <div class="form-text">Optional: Provide contact info if emergency services need to reach you</div>
          </div>
          
          <div class="mb-3">
            <label for="flood-images" class="form-label">Upload Photos</label>
            <input type="file" class="form-control" id="flood-images" multiple accept="image/*">
            <div class="form-text">Photos help assess the situation more accurately</div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="submit-flood-report-btn">
          <i class="fas fa-paper-plane me-1"></i>Submit Report
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Layer Control Modal -->
<div class="modal fade" id="layerControlModal" tabindex="-1" aria-labelledby="layerControlModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header admin">
        <h5 class="modal-title" id="layerControlModalLabel">
          <i class="fas fa-layer-group me-2"></i>Layer Control
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <h6 class="mb-3">Overlay Layers</h6>
        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" id="layer-drainage" checked>
          <label class="form-check-label" for="layer-drainage">
            <i class="fas fa-map-pin me-2 text-primary"></i>Drainage Points
          </label>
        </div>
        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" id="layer-flood-prone" >
          <label class="form-check-label" for="layer-flood-prone">
            <i class="fas fa-water me-2 text-info"></i>Flood-prone Areas
          </label>
        </div>
        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" id="layer-maintenance">
          <label class="form-check-label" for="layer-maintenance">
            <i class="fas fa-route me-2 text-warning"></i>Maintenance Routes
          </label>
        </div>
        
        <hr>
        <h6 class="mb-3">Base Maps</h6>
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" name="basemap" id="basemap-street" checked>
          <label class="form-check-label" for="basemap-street">
            <i class="fas fa-road me-2"></i>Street Map
          </label>
        </div>
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" name="basemap" id="basemap-satellite">
          <label class="form-check-label" for="basemap-satellite">
            <i class="fas fa-satellite me-2"></i>Satellite Imagery
          </label>
        </div>
        <div class="form-check mb-2">
          <input class="form-check-input" type="radio" name="basemap" id="basemap-terrain">
          <label class="form-check-label" for="basemap-terrain">
            <i class="fas fa-mountain me-2"></i>Terrain
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Point Details Modal -->
<div class="modal fade" id="pointDetailsModal" tabindex="-1" aria-labelledby="pointDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header admin">
        <h5 class="modal-title" id="pointDetailsModalLabel">
          <i class="fas fa-info-circle me-2"></i>Drainage Point Details
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6">
            <div class="card mb-3">
              <div class="card-header admin">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>General Information</h5>
              </div>
              <div class="card-body">
                <table class="table table-borderless">
                  <tbody id="point-details-table">
                    <!-- Populated dynamically -->
                  </tbody>
                </table>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header admin">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Maintenance History</h5>
              </div>
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-sm" id="maintenance-history-table">
                    <!-- Populated dynamically -->
                  </table>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="card mb-3">
              <div class="card-header admin">
                <h5 class="mb-0"><i class="fas fa-images me-2"></i>Photo Gallery</h5>
              </div>
              <div class="card-body">
                <div id="point-image-gallery" class="d-flex flex-wrap gap-2">
                  <!-- Populated dynamically -->
                </div>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header admin">
                <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Quick Actions</h5>
              </div>
              <div class="card-body">
                <div class="d-grid gap-2">
                  <button class="btn btn-outline-success" onclick="showScheduleInspectionModal(currentPointId)">
                    <i class="fas fa-clipboard-check me-2"></i>Schedule Inspection
                  </button>
                  <button class="btn btn-outline-warning" onclick="showRequestMaintenanceModal(currentPointId)">
                    <i class="fas fa-wrench me-2"></i>Request Maintenance
                  </button>
                  <button class="btn btn-outline-info">
                    <i class="fas fa-download me-2"></i>Download Report
                  </button>
                </div>
              </div>
            </div>
            
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="edit-point-btn">
          <i class="fas fa-edit me-1"></i>Edit Point
        </button>
        <button type="button" class="btn btn-danger" id="delete-point-btn">
          <i class="fas fa-trash me-1"></i>Delete Point
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header admin">
        <h5 class="modal-title" id="exportModalLabel">
          <i class="fas fa-download me-2"></i>Export Data
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="export-format" class="form-label">Export Format</label>
          <select class="form-select" id="export-format">
            <option value="csv">CSV Spreadsheet</option>
            <option value="xlsx">Excel Workbook</option>
            <option value="geojson">GeoJSON</option>
            <option value="pdf">PDF Report</option>
          </select>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Include Data</label>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="export-drainage" checked>
            <label class="form-check-label" for="export-drainage">Drainage Points</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="export-flood-prone" checked>
            <label class="form-check-label" for="export-flood-prone">Flood-prone Areas</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" id="export-maintenance">
            <label class="form-check-label" for="export-maintenance">Maintenance Records</label>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <label class="form-label">Filter by Type</label>
            <select class="form-select" id="export-filter-type">
              <option value="all">All Types</option>
              <option value="concrete">Concrete Drains</option>
              <option value="earth">Earth Drains</option>
              <option value="box-culvert">Box Culverts</option>
              <option value="pipe">Pipe Drains</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Filter by Status</label>
            <select class="form-select" id="export-filter-status">
              <option value="all">All Statuses</option>
              <option value="good">Good Condition</option>
              <option value="needs-maintenance">Needs Maintenance</option>
              <option value="critical">Critical</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="confirm-export-btn">
          <i class="fas fa-download me-1"></i>Export Data
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Add these modals before the closing </body> tag in your map.html -->

<!-- Request Maintenance Modal -->
<div class="modal fade" id="requestMaintenanceModal" tabindex="-1" aria-labelledby="requestMaintenanceModalLabel" aria-hidden="true">
<div class="modal-dialog modal-lg">
  <div class="modal-content">
    <div class="modal-header bg-warning">
      <h5 class="modal-title" id="requestMaintenanceModalLabel">
        <i class="fas fa-wrench me-2"></i>Request Maintenance
      </h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <form id="maintenance-request-form">
        <input type="hidden" id="maintenance-drainage-point-id" name="drainage_point_id">
        
        <div class="mb-3">
          <label for="maintenance-point-name" class="form-label">Drainage Point</label>
          <input type="text" class="form-control" id="maintenance-point-name" readonly>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="maintenance-type" class="form-label">Maintenance Type *</label>
              <select class="form-select" id="maintenance-type" required>
                <option value="">Select maintenance type</option>
                <option value="Cleaning">Cleaning</option>
                <option value="Repair">Repair</option>
                <option value="Replacement">Replacement</option>
                <option value="Inspection">Inspection</option>
                <option value="Upgrade">Upgrade</option>
                <option value="Emergency Repair">Emergency Repair</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="maintenance-priority" class="form-label">Priority *</label>
              <select class="form-select" id="maintenance-priority" required>
                <option value="Low">Low</option>
                <option value="Medium" selected>Medium</option>
                <option value="High">High</option>
                <option value="Critical">Critical</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="mb-3">
          <label for="maintenance-description" class="form-label">Description *</label>
          <textarea class="form-control" id="maintenance-description" rows="4" required 
                    placeholder="Describe the issue and required maintenance work..."></textarea>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="maintenance-estimated-cost" class="form-label">Estimated Cost (RM)</label>
              <input type="number" class="form-control" id="maintenance-estimated-cost" 
                     step="0.01" min="0" placeholder="0.00">
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="maintenance-scheduled-date" class="form-label">Preferred Date</label>
              <input type="date" class="form-control" id="maintenance-scheduled-date">
            </div>
          </div>
        </div>
        
        <div class="mb-3">
          <label for="maintenance-assigned-to" class="form-label">Assign To</label>
          <select class="form-select" id="maintenance-assigned-to">
            <option value="">Select team member (optional)</option>
            <!-- Will be populated dynamically -->
          </select>
        </div>
        
        <div class="mb-3">
          <label for="maintenance-notes" class="form-label">Additional Notes</label>
          <textarea class="form-control" id="maintenance-notes" rows="2" 
                    placeholder="Any additional information or special requirements..."></textarea>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button type="button" class="btn btn-warning" id="submit-maintenance-request-btn">
        <i class="fas fa-paper-plane me-1"></i>Submit Request
      </button>
    </div>
  </div>
</div>
</div>

<!-- Schedule Inspection Modal -->
<div class="modal fade" id="scheduleInspectionModal" tabindex="-1" aria-labelledby="scheduleInspectionModalLabel" aria-hidden="true">
<div class="modal-dialog modal-lg">
  <div class="modal-content">
    <div class="modal-header bg-success">
      <h5 class="modal-title" id="scheduleInspectionModalLabel">
        <i class="fas fa-clipboard-check me-2"></i>Schedule Inspection
      </h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <form id="inspection-schedule-form">
        <input type="hidden" id="inspection-drainage-point-id" name="drainage_point_id">
        
        <div class="mb-3">
          <label for="inspection-point-name" class="form-label">Drainage Point</label>
          <input type="text" class="form-control" id="inspection-point-name" readonly>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="inspection-type" class="form-label">Inspection Type *</label>
              <select class="form-select" id="inspection-type" required>
                <option value="">Select inspection type</option>
                <option value="Routine Inspection">Routine Inspection</option>
                <option value="Safety Inspection">Safety Inspection</option>
                <option value="Structural Inspection">Structural Inspection</option>
                <option value="Emergency Inspection">Emergency Inspection</option>
                <option value="Post-Maintenance Inspection">Post-Maintenance Inspection</option>
                <option value="Compliance Inspection">Compliance Inspection</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="inspection-priority" class="form-label">Priority *</label>
              <select class="form-select" id="inspection-priority" required>
                <option value="Low">Low</option>
                <option value="Medium" selected>Medium</option>
                <option value="High">High</option>
                <option value="Critical">Critical</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="inspection-scheduled-date" class="form-label">Scheduled Date *</label>
              <input type="date" class="form-control" id="inspection-scheduled-date" required>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="inspection-scheduled-time" class="form-label">Scheduled Time</label>
              <input type="time" class="form-control" id="inspection-scheduled-time">
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label for="inspection-frequency" class="form-label">Frequency</label>
              <select class="form-select" id="inspection-frequency">
                <option value="One-time" selected>One-time</option>
                <option value="Weekly">Weekly</option>
                <option value="Monthly">Monthly</option>
                <option value="Quarterly">Quarterly</option>
                <option value="Yearly">Yearly</option>
              </select>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="inspection-inspector" class="form-label">Inspector</label>
              <select class="form-select" id="inspection-inspector">
                <option value="">Select inspector (optional)</option>
                <!-- Will be populated dynamically -->
              </select>
            </div>
          </div>
        </div>
        
        <div class="mb-3">
          <label for="inspection-description" class="form-label">Description</label>
          <textarea class="form-control" id="inspection-description" rows="3" 
                    placeholder="Describe the purpose and scope of this inspection..."></textarea>
        </div>
        
        <div class="mb-3">
          <label class="form-label">Inspection Checklist</label>
          <div class="border rounded p-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="checklist-structural">
              <label class="form-check-label" for="checklist-structural">
                Structural integrity assessment
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="checklist-blockage">
              <label class="form-check-label" for="checklist-blockage">
                Check for blockages or debris
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="checklist-flow">
              <label class="form-check-label" for="checklist-flow">
                Water flow assessment
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="checklist-safety">
              <label class="form-check-label" for="checklist-safety">
                Safety hazard identification
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="checklist-maintenance">
              <label class="form-check-label" for="checklist-maintenance">
                Maintenance requirements evaluation
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="checklist-documentation">
              <label class="form-check-label" for="checklist-documentation">
                Photo documentation
              </label>
            </div>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button type="button" class="btn btn-success" id="submit-inspection-schedule-btn">
        <i class="fas fa-calendar-plus me-1"></i>Schedule Inspection
      </button>
    </div>
  </div>
</div>
</div>

<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
<script src="../js/map.js"></script>

<script>
  
    
    
    
    // Enhanced filter functionality

    const depthRange = document.getElementById('depth-range');
    const depthValue = document.getElementById('depth-value');
    
    
    // Handle depth range
    depthRange.addEventListener('input', function() {
      const value = this.value;
      depthValue.textContent = `0-${value}m`;
      applyDepthFilter(value);
    });
    
    // Filter functions (integrate with your existing map.js)
    function applyFilter(type, value) {
      console.log(`Applying ${type} filter:`, value);
      // Integrate with your existing filter logic in map.js
      if (window.handleFilterChange) {
        window.handleFilterChange(type, value);
      }
    }
    
    function applyDepthFilter(maxDepth) {
      console.log('Applying depth filter:', maxDepth);
      // Integrate with your existing depth filter logic
      if (window.handleDepthFilter) {
        window.handleDepthFilter(maxDepth);
      }
    }
</script>
</body>
</html>