<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DrainTrack - Flood Reports</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Leaflet CSS for mini maps -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.css" rel="stylesheet">
  <!-- Common DrainTrack Styles -->
  <link href="../css/common.css" rel="stylesheet">
  
  <style>
    /* Page-specific styles for flood reports */
    .filter-section {
      background: white;
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .filter-control {
      margin-bottom: 1rem;
    }

    .filter-control:last-child {
      margin-bottom: 0;
    }

    .severity-badge {
      padding: 0.5rem 1rem;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .severity-minor {
      background-color: var(--success-color);
      color: white;
    }

    .severity-moderate {
      background-color: var(--warning-color);
      color: black;
    }

    .severity-severe {
      background-color: var(--danger-color);
      color: white;
    }

    .severity-extreme {
      background-color: var(--dark-color);
      color: white;
    }

    .status-badge {
      padding: 0.4rem 0.8rem;
      border-radius: 15px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-pending {
      background-color: #fef3c7;
      color: #92400e;
    }

    .status-investigating {
      background-color: #dbeafe;
      color: #1e40af;
    }

    .status-resolved {
      background-color: #d1fae5;
      color: #065f46;
    }

    .status-closed {
      background-color: #f3f4f6;
      color: #374151;
    }

    .report-row {
      transition: all 0.3s ease;
    }

    .report-row:hover {
      background-color: #f8f9fa;
      transform: scale(1.01);
    }

    .mini-map {
      width: 80px;
      height: 60px;
      border-radius: 8px;
      border: 2px solid #e9ecef;
    }

    .action-buttons .btn {
      margin-right: 0.25rem;
      margin-bottom: 0.25rem;
    }

    .urgency-indicator {
      width: 4px;
      height: 100%;
      position: absolute;
      left: 0;
      top: 0;
      border-radius: 0 4px 4px 0;
    }

    .urgency-low {
      background-color: var(--success-color);
    }

    .urgency-medium {
      background-color: var(--warning-color);
    }

    .urgency-high {
      background-color: var(--danger-color);
    }

    .urgency-critical {
      background-color: var(--dark-color);
    }

    .search-container {
      position: relative;
      margin-bottom: 1.5rem;
    }

    .search-container .form-control {
      border-radius: 15px;
      border: 2px solid #e9ecef;
      padding: 1rem 1rem 1rem 3rem;
      font-size: 1rem;
      transition: all 0.3s ease;
      background: #f8f9fa;
    }

    .search-container .form-control:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.15);
      background: white;
    }

    .search-container i {
      position: absolute;
      left: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--secondary-color);
      z-index: 10;
    }

    .quick-filter-btn {
      border-radius: 20px;
      padding: 0.5rem 1rem;
      margin: 0.25rem;
      border: 2px solid #e9ecef;
      background: white;
      color: var(--dark-color);
      font-weight: 500;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .quick-filter-btn:hover {
      border-color: var(--primary-color);
      background-color: var(--primary-color);
      color: white;
    }

    .quick-filter-btn.active {
      border-color: var(--primary-color);
      background-color: var(--primary-color);
      color: white;
    }

    .pagination-container {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-top: 1rem;
    }

    .bulk-actions {
      background: linear-gradient(90deg, var(--warning-color), #ff6b35);
      color: white;
      border-radius: 15px;
      padding: 1rem;
      margin-bottom: 1rem;
      display: none;
    }

    .bulk-actions.show {
      display: block;
    }

    .export-section {
      background: white;
      border-radius: 15px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }

    .urgent-alert {
      animation: pulse 2s infinite;
    }

    /* Loading overlay styles */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s ease;
    }

    .loading-content {
      text-align: center;
      color: var(--primary-color);
    }

    .loading-spinner {
      width: 3rem;
      height: 3rem;
      margin-bottom: 1rem;
    }

    /* Notification styles */
    .notification {
      position: fixed;
      top: 100px;
      right: 20px;
      z-index: 9999;
      max-width: 400px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    @media (max-width: 768px) {
      .filter-section {
        padding: 1rem;
      }
      
      .action-buttons .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="spinner-border loading-spinner" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <h4>Loading Dashboard...</h4>
      <p>Please wait while we prepare your workspace</p>
    </div>
  </div>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="admin.html">
        <i class="fas fa-water"></i>
        DrainTrack
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="admin.html">
              <i class="fas fa-tachometer-alt me-1"></i>Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="map.html">
              <i class="fas fa-map me-1"></i>Interactive Map
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="flood-report.html">
              <i class="fas fa-exclamation-triangle me-1"></i>Flood Reports
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="maintanance-inspection.html">
              <i class="fas fa-tools me-1"></i>Management
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="user.html">
              <i class="fas fa-users me-1"></i>User Management
            </a>
          </li>
        </ul>
        <div class="ms-3">
          <div class="dropdown">
            <a class="btn btn-outline-light dropdown-toggle" href="#" role="button" id="userDropdown" data-bs-toggle="dropdown">
              <i class="fas fa-user-circle me-1"></i><span id="userName">Admin</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>Profile</a></li>
              <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Settings</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="main-content">
    <div class="container-fluid">
      <!-- Page Header -->
      <div class="row mb-4">
        <div class="col-12">
          <h1 class="h2 mb-3 text-gradient">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Flood Reports Management
          </h1>
          <p class="text-muted">Monitor and manage flood reports from citizens and field staff.</p>
        </div>
      </div>

      <!-- Statistics Cards -->
      <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
          <div class="card stats-card danger position-relative animate-slide-in">
            <div class="stats-number" id="total-reports">0</div>
            <div class="stats-label">Total Reports</div>
            <i class="fas fa-exclamation-triangle stats-icon"></i>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="card stats-card warning position-relative animate-slide-in">
            <div class="stats-number" id="pending-reports">0</div>
            <div class="stats-label">Pending Review</div>
            <i class="fas fa-clock stats-icon"></i>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="card stats-card info position-relative animate-slide-in">
            <div class="stats-number" id="investigating-reports">0</div>
            <div class="stats-label">Under Investigation</div>
            <i class="fas fa-search stats-icon"></i>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="card stats-card success position-relative animate-slide-in">
            <div class="stats-number" id="resolved-reports">0</div>
            <div class="stats-label">Resolved</div>
            <i class="fas fa-check-circle stats-icon"></i>
          </div>
        </div>
      </div>

      <!-- Export and Bulk Actions -->
      <div class="export-section animate-fade-in">
        <div class="row align-items-center">
          <div class="col-md-6">
            <h6 class="mb-0">
              <i class="fas fa-file-export me-2"></i>
              Export Reports
            </h6>
          </div>
          <div class="col-md-6 text-md-end">
            <button class="btn btn-outline-primary btn-sm me-2" onclick="exportReports('csv')">
              <i class="fas fa-file-csv me-1"></i> CSV
            </button>
            <button class="btn btn-outline-primary btn-sm me-2" onclick="exportReports('excel')">
              <i class="fas fa-file-excel me-1"></i> Excel
            </button>
            <button class="btn btn-outline-primary btn-sm" onclick="exportReports('pdf')">
              <i class="fas fa-file-pdf me-1"></i> PDF
            </button>
          </div>
        </div>
      </div>

      <!-- Bulk Actions Bar -->
      <div class="bulk-actions animate-fade-in" id="bulk-actions">
        <div class="row align-items-center">
          <div class="col-md-6">
            <span id="selected-count">0</span> reports selected
          </div>
          <div class="col-md-6 text-md-end">
            <button class="btn btn-light btn-sm me-2" onclick="bulkUpdateStatus('investigating')">
              <i class="fas fa-search me-1"></i> Mark as Investigating
            </button>
            <button class="btn btn-light btn-sm me-2" onclick="bulkUpdateStatus('resolved')">
              <i class="fas fa-check me-1"></i> Mark as Resolved
            </button>
            <button class="btn btn-outline-light btn-sm" onclick="clearSelection()">
              <i class="fas fa-times me-1"></i> Clear Selection
            </button>
          </div>
        </div>
      </div>

      <!-- Filters Section -->
      <div class="filter-section animate-fade-in">
        <div class="row">
          <div class="col-md-4">
            <div class="filter-control">
              <label class="form-label fw-bold">
                <i class="fas fa-search me-2"></i>Search Reports
              </label>
              <div class="search-container">
                <i class="fas fa-search"></i>
                <input type="text" class="form-control" id="searchInput" placeholder="Search by location, description, or contact...">
              </div>
            </div>
          </div>
          <div class="col-md-2">
            <div class="filter-control">
              <label class="form-label fw-bold">Severity</label>
              <select class="form-select" id="severityFilter" title="Filter by severity">
                <option value="">All Severities</option>
                <option value="Minor">Minor</option>
                <option value="Moderate">Moderate</option>
                <option value="Severe">Severe</option>
                <option value="Extreme">Extreme</option>
              </select>
            </div>
          </div>
          <div class="col-md-2">
            <div class="filter-control">
              <label class="form-label fw-bold">Status</label>
              <select class="form-select" id="statusFilter" title="Filter by status">
                <option value="">All Statuses</option>
                <option value="pending">Pending</option>
                <option value="investigating">Investigating</option>
                <option value="resolved">Resolved</option>
                <option value="closed">Closed</option>
              </select>
            </div>
          </div>
          <div class="col-md-2">
            <div class="filter-control">
              <label class="form-label fw-bold">Date Range</label>
              <select class="form-select" id="dateFilter" title="Filter by date range">
                <option value="">All Time</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
                <option value="custom">Custom Range</option>
              </select>
            </div>
          </div>
          <div class="col-md-2">
            <div class="filter-control">
              <label class="form-label fw-bold">Actions</label>
              <div>
                <button class="btn btn-primary w-100" onclick="applyFilters()">
                  <i class="fas fa-filter me-1"></i> Apply Filters
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Quick Filter Buttons -->
        <div class="row mt-3">
          <div class="col-12">
            <label class="form-label fw-bold">Quick Filters:</label>
            <div>
              <button class="quick-filter-btn active" data-filter="all">All Reports</button>
              <button class="quick-filter-btn" data-filter="urgent">Urgent (Severe + Extreme)</button>
              <button class="quick-filter-btn" data-filter="today">Today's Reports</button>
              <button class="quick-filter-btn" data-filter="pending">Pending Review</button>
              <button class="quick-filter-btn" data-filter="high-water">High Water Depth (>5cm)</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Reports Table -->
      <div class="card dashboard-card animate-fade-in">
        <div class="card-header card-header-custom d-flex justify-content-between align-items-center">
          <div>
            <i class="fas fa-list"></i>
            Flood Reports (<span id="report-count">0</span>)
          </div>
          <div>
            <button class="btn btn-light btn-sm" onclick="refreshReports()">
              <i class="fas fa-sync-alt"></i> Refresh
            </button>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0" id="reportsTable">
              <thead>
                <tr>
                  <th width="40">
                    <label for="selectAll" class="visually-hidden">Select all reports</label>
                    <input type="checkbox" id="selectAll" title="Select all reports" onchange="toggleSelectAll()">
                  </th>
                  <th width="80">Map</th>
                  <th>Location</th>
                  <th>Severity</th>
                  <th>Water Depth</th>
                  <th>Description</th>
                  <th>Contact</th>
                  <th>Reported</th>
                  <th>Status</th>
                  <th width="150">Actions</th>
                </tr>
              </thead>
              <tbody id="reportsTableBody">
                <!-- Reports will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Pagination -->
      <div class="pagination-container">
        <div class="d-flex justify-content-between align-items-center w-100">
          <div>
            <small class="text-muted">
              Showing <span id="showing-start">0</span> to <span id="showing-end">0</span> of <span id="total-records">0</span> reports
            </small>
          </div>
          <nav>
            <ul class="pagination mb-0" id="pagination">
              <!-- Pagination buttons will be generated here -->
            </ul>
          </nav>
          <div>
            <select class="form-select form-select-sm" id="recordsPerPage" onchange="changeRecordsPerPage()" aria-label="Records per page">
              <option value="10">10 per page</option>
              <option value="25" selected>25 per page</option>
              <option value="50">50 per page</option>
              <option value="100">100 per page</option>
            </select>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Details Modal -->
  <div class="modal fade" id="reportDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Flood Report Details
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="reportDetailsContent">
          <!-- Report details will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-warning" onclick="updateReportStatus('investigating')">
            <i class="fas fa-search me-1"></i> Mark as Investigating
          </button>
          <button type="button" class="btn btn-success" onclick="updateReportStatus('resolved')">
            <i class="fas fa-check me-1"></i> Mark as Resolved
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <!-- Leaflet JS for mini maps -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.js"></script>

  <script>
    // Global variables
    let floodReports = [];
    let filteredReports = [];
    let currentPage = 1;
    let recordsPerPage = 25;
    let selectedReports = new Set();
    let currentReportId = null;
    let currentUser = null;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      checkAuthentication();
    });

    /**
     * Check if user is authenticated and has appropriate role
     */
    async function checkAuthentication() {
      try {
        const response = await fetch('../api/session-check.php');
        const result = await response.json();
        
        if (result.success && result.authenticated) {
          // Check if user has Admin role
          if (result.user.role !== 'Admin') {
            showNotification('Access denied. This page is for administrators only.', 'danger');
            setTimeout(() => {
              window.location.href = '../login.html?unauthorized=1';
            }, 2000);
            return;
          }
          
          currentUser = result.user;
          document.getElementById('userName').textContent = currentUser.name;
          hideLoadingOverlay();
          initializePage();
        } else {
          // Redirect to login page
          window.location.href = '../login.html?unauthorized=1';
        }
      } catch (error) {
        console.error('Authentication check failed:', error);
        showNotification('Authentication check failed. Redirecting to login...', 'danger');
        setTimeout(() => {
          window.location.href = '../login.html?error=1';
        }, 2000);
      }
    }

    /**
     * Hide the loading overlay
     */
    function hideLoadingOverlay() {
      const overlay = document.getElementById('loadingOverlay');
      overlay.style.opacity = '0';
      setTimeout(() => {
        overlay.style.display = 'none';
      }, 300);
    }

    /**
     * Logout function - redirect to centralized login
     */
    async function logout() {
      try {
        showNotification('Logging out...', 'info');
        
        // Clear session on server
        await fetch('../api/logout.php', { method: 'POST' });
        
        // Redirect to login page
        window.location.href = '../login.html?logout=1';
      } catch (error) {
        console.error('Logout failed:', error);
        // Still redirect even if logout request fails
        window.location.href = '../login.html?logout=1';
      }
    }

    /**
     * Initialize page after authentication
     */
    function initializePage() {
      loadFloodReports();
      setupEventListeners();
      
      // Auto-refresh every 60 seconds
      setInterval(loadFloodReports, 60000);
    }

    function setupEventListeners() {
      // Search input
      document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 300));
      
      // Filter selects
      document.getElementById('severityFilter').addEventListener('change', applyFilters);
      document.getElementById('statusFilter').addEventListener('change', applyFilters);
      document.getElementById('dateFilter').addEventListener('change', applyFilters);
      
      // Quick filter buttons
      document.querySelectorAll('.quick-filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.quick-filter-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          applyQuickFilter(this.dataset.filter);
        });
      });
    }

    // Enhanced load function with better error handling and database connection
    async function loadFloodReports() {
      try {
        showNotification('Loading flood reports...', 'info');
        
        const response = await fetch('/DrainageInventory/api/flood-reports.php');
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (Array.isArray(data)) {
          floodReports = data.map(report => ({
            ...report,
            // Ensure status exists, default to 'pending' if not
            status: report.status || 'pending',
            // Calculate urgency if not provided
            urgency: report.urgency || calculateUrgency(report.severity, report.water_depth)
          }));
          
          updateStatistics();
          applyFilters();
          showNotification(`Loaded ${data.length} flood reports successfully`, 'success');
          console.log('✅ Database connection successful! Loaded', data.length, 'flood reports');
        } else {
          throw new Error('Invalid data format received');
        }
        
      } catch (error) {
        console.error('❌ Error loading flood reports:', error);
        showNotification('Failed to load flood reports. Using sample data.', 'warning');
        loadSampleData();
      }
    }

    function loadSampleData() {
      console.log('📝 Loading sample data for demonstration');
      
      // Sample flood reports data
      floodReports = [
        {
          id: 1,
          location: "Junction 5 Area, Muar",
          latitude: 2.046098,
          longitude: 102.605782,
          severity: "Moderate",
          water_depth: 15,
          description: "Water accumulation at main junction causing traffic disruption. Several vehicles unable to pass through.",
          contact: "Ahmad Rahman - 012-3456789",
          timestamp: "2025-06-03 14:30:00",
          status: "investigating",
          urgency: "medium"
        },
        {
          id: 2,
          location: "Hospital Road",
          latitude: 2.057882,
          longitude: 102.574719,
          severity: "Severe",
          water_depth: 25,
          description: "Severe flooding near hospital entrance. Emergency vehicles affected. Immediate attention required.",
          contact: "Dr. Sarah Lee - 019-8765432",
          timestamp: "2025-06-03 13:15:00",
          status: "pending",
          urgency: "high"
        },
        {
          id: 3,
          location: "Residential Area - Taman Muar",
          latitude: 2.033229,
          longitude: 102.621059,
          severity: "Minor",
          water_depth: 8,
          description: "Minor flooding in residential area. Some houses have water entering compound.",
          contact: "Fatimah Abdullah - 017-2345678",
          timestamp: "2025-06-03 12:45:00",
          status: "resolved",
          urgency: "low"
        },
        {
          id: 4,
          location: "Industrial Zone",
          latitude: 2.061288,
          longitude: 102.607412,
          severity: "Extreme",
          water_depth: 45,
          description: "Critical flooding in industrial area. Multiple factories affected. Production halted.",
          contact: "Factory Manager - 016-7890123",
          timestamp: "2025-06-03 11:20:00",
          status: "investigating",
          urgency: "critical"
        },
        {
          id: 5,
          location: "School Area - SMK Muar",
          latitude: 2.048568,
          longitude: 102.578422,
          severity: "Moderate",
          water_depth: 12,
          description: "Flooding around school compound. Students dismissed early as precautionary measure.",
          contact: "Headmaster - 013-4567890",
          timestamp: "2025-06-03 10:30:00",
          status: "resolved",
          urgency: "medium"
        },
        {
          id: 6,
          location: "Market Square",
          latitude: 2.050527,
          longitude: 102.571481,
          severity: "Minor",
          water_depth: 5,
          description: "Light flooding at market area. Vendors moving goods to higher ground.",
          contact: "Market Committee - 014-5678901",
          timestamp: "2025-06-02 16:45:00",
          status: "pending",
          urgency: "low"
        }
      ];
      
      updateStatistics();
      applyFilters();
    }

    function calculateUrgency(severity, waterDepth) {
      if (severity === 'Extreme' || waterDepth > 30) return 'critical';
      if (severity === 'Severe' || waterDepth > 20) return 'high';
      if (severity === 'Moderate' || waterDepth > 10) return 'medium';
      return 'low';
    }

    function updateStatistics() {
      const total = floodReports.length;
      const pending = floodReports.filter(r => r.status === 'pending').length;
      const investigating = floodReports.filter(r => r.status === 'investigating').length;
      const resolved = floodReports.filter(r => r.status === 'resolved').length;

      animateCounter('total-reports', total);
      animateCounter('pending-reports', pending);
      animateCounter('investigating-reports', investigating);
      animateCounter('resolved-reports', resolved);
    }

    function animateCounter(elementId, targetValue) {
      const element = document.getElementById(elementId);
      const startValue = 0;
      const duration = 1500;
      const startTime = performance.now();
      
      function updateCounter(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const currentValue = Math.floor(startValue + (targetValue - startValue) * progress);
        
        element.textContent = currentValue;
        
        if (progress < 1) {
          requestAnimationFrame(updateCounter);
        }
      }
      
      requestAnimationFrame(updateCounter);
    }

    // Additional functions remain the same as the original...
    function applyFilters() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const severityFilter = document.getElementById('severityFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;
      const dateFilter = document.getElementById('dateFilter').value;

      filteredReports = floodReports.filter(report => {
        // Search filter
        const matchesSearch = !searchTerm || 
          report.location.toLowerCase().includes(searchTerm) ||
          report.description.toLowerCase().includes(searchTerm) ||
          (report.contact && report.contact.toLowerCase().includes(searchTerm));

        // Severity filter
        const matchesSeverity = !severityFilter || report.severity === severityFilter;

        // Status filter
        const matchesStatus = !statusFilter || report.status === statusFilter;

        // Date filter
        const matchesDate = filterByDate(report.timestamp, dateFilter);

        return matchesSearch && matchesSeverity && matchesStatus && matchesDate;
      });

      currentPage = 1;
      renderTable();
      updatePagination();
    }

    function applyQuickFilter(filter) {
      // Reset other filters
      document.getElementById('searchInput').value = '';
      document.getElementById('severityFilter').value = '';
      document.getElementById('statusFilter').value = '';
      document.getElementById('dateFilter').value = '';

      switch(filter) {
        case 'all':
          filteredReports = [...floodReports];
          break;
        case 'urgent':
          filteredReports = floodReports.filter(r => r.severity === 'Severe' || r.severity === 'Extreme');
          break;
        case 'today':
          const today = new Date().toISOString().split('T')[0];
          filteredReports = floodReports.filter(r => r.timestamp.startsWith(today));
          break;
        case 'pending':
          filteredReports = floodReports.filter(r => r.status === 'pending');
          break;
        case 'high-water':
          filteredReports = floodReports.filter(r => r.water_depth > 5);
          break;
      }

      currentPage = 1;
      renderTable();
      updatePagination();
    }

    function filterByDate(timestamp, filter) {
      if (!filter) return true;
      
      const reportDate = new Date(timestamp);
      const now = new Date();
      
      switch(filter) {
        case 'today':
          return reportDate.toDateString() === now.toDateString();
        case 'week':
          const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
          return reportDate >= weekAgo;
        case 'month':
          const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
          return reportDate >= monthAgo;
        default:
          return true;
      }
    }

    function renderTable() {
      const tbody = document.getElementById('reportsTableBody');
      const start = (currentPage - 1) * recordsPerPage;
      const end = start + recordsPerPage;
      const pageReports = filteredReports.slice(start, end);

      tbody.innerHTML = pageReports.map(report => {
        const severityClass = `severity-${report.severity.toLowerCase()}`;
        const statusClass = `status-${report.status}`;
        const urgencyClass = `urgency-${report.urgency}`;
        const isUrgent = report.urgency === 'critical' || report.urgency === 'high';

        return `
          <tr class="report-row position-relative ${isUrgent ? 'urgent-alert' : ''}" data-id="${report.id}">
            <td>
              <div class="urgency-indicator ${urgencyClass}"></div>
              <input type="checkbox" class="report-checkbox" value="${report.id}" onchange="toggleReportSelection(${report.id})">
            </td>
            <td>
              <div class="mini-map" id="map-${report.id}"></div>
            </td>
            <td>
              <div class="fw-bold">${report.location}</div>
              <small class="text-muted">
                <i class="fas fa-map-marker-alt me-1"></i>
                ${report.latitude?.toFixed(4)}, ${report.longitude?.toFixed(4)}
              </small>
            </td>
            <td>
              <span class="severity-badge ${severityClass}">${report.severity}</span>
            </td>
            <td>
              <span class="fw-bold ${report.water_depth > 20 ? 'text-danger' : report.water_depth > 10 ? 'text-warning' : 'text-success'}">
                ${report.water_depth}cm
              </span>
            </td>
            <td>
              <div class="text-truncate" style="max-width: 200px;" title="${report.description}">
                ${report.description}
              </div>
            </td>
            <td>
              <small>${report.contact || 'Not provided'}</small>
            </td>
            <td>
              <div>${formatDate(report.timestamp)}</div>
              <small class="text-muted">${formatTime(report.timestamp)}</small>
            </td>
            <td>
              <span class="status-badge ${statusClass}">${capitalizeFirst(report.status)}</span>
            </td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-sm btn-primary" onclick="viewReportDetails(${report.id})" title="View Details">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-info" onclick="showOnMap(${report.latitude}, ${report.longitude})" title="Show on Map">
                  <i class="fas fa-map-marker-alt"></i>
                </button>
                <div class="btn-group">
                  <button class="btn btn-sm btn-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-cog"></i>
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="updateReportStatus(${report.id}, 'investigating')">
                      <i class="fas fa-search me-2"></i>Mark as Investigating
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="updateReportStatus(${report.id}, 'resolved')">
                      <i class="fas fa-check me-2"></i>Mark as Resolved
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="updateReportStatus(${report.id}, 'closed')">
                      <i class="fas fa-times me-2"></i>Close Report
                    </a></li>
                  </ul>
                </div>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      // Initialize mini maps
      setTimeout(() => {
        pageReports.forEach(report => {
          if (report.latitude && report.longitude) {
            initMiniMap(report.id, report.latitude, report.longitude);
          }
        });
      }, 100);

      // Update report count
      document.getElementById('report-count').textContent = filteredReports.length;
    }

    function initMiniMap(reportId, lat, lng) {
      const mapElement = document.getElementById(`map-${reportId}`);
      if (!mapElement) return;

      try {
        const map = L.map(`map-${reportId}`, {
          center: [lat, lng],
          zoom: 15,
          zoomControl: false,
          attributionControl: false,
          dragging: false,
          scrollWheelZoom: false,
          doubleClickZoom: false,
          boxZoom: false,
          keyboard: false
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        L.marker([lat, lng], {
          icon: L.divIcon({
            className: 'custom-div-icon',
            html: '<div style="background-color: #dc3545; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>',
            iconSize: [16, 16],
            iconAnchor: [8, 8]
          })
        }).addTo(map);
      } catch (error) {
        console.error('Error initializing mini map:', error);
        mapElement.innerHTML = '<div class="d-flex align-items-center justify-content-center h-100 text-muted"><i class="fas fa-map"></i></div>';
      }
    }

    // Continue with the rest of the functions from original flood-report.html...
    function updatePagination() {
      const totalPages = Math.ceil(filteredReports.length / recordsPerPage);
      const pagination = document.getElementById('pagination');
      
      let paginationHTML = '';
      
      // Previous button
      paginationHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
        </li>
      `;
      
      // Page numbers
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage < maxVisiblePages - 1) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
          </li>
        `;
      }
      
      // Next button
      paginationHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
        </li>
      `;
      
      pagination.innerHTML = paginationHTML;
      
      // Update showing info
      const start = (currentPage - 1) * recordsPerPage + 1;
      const end = Math.min(currentPage * recordsPerPage, filteredReports.length);
      
      document.getElementById('showing-start').textContent = filteredReports.length > 0 ? start : 0;
      document.getElementById('showing-end').textContent = end;
      document.getElementById('total-records').textContent = filteredReports.length;
    }

    function changePage(page) {
      const totalPages = Math.ceil(filteredReports.length / recordsPerPage);
      if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderTable();
        updatePagination();
      }
    }

    function changeRecordsPerPage() {
      recordsPerPage = parseInt(document.getElementById('recordsPerPage').value);
      currentPage = 1;
      renderTable();
      updatePagination();
    }

    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAll');
      const checkboxes = document.querySelectorAll('.report-checkbox');
      
      checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
        const reportId = parseInt(checkbox.value);
        if (selectAll.checked) {
          selectedReports.add(reportId);
        } else {
          selectedReports.delete(reportId);
        }
      });
      
      updateBulkActions();
    }

    function toggleReportSelection(reportId) {
      if (selectedReports.has(reportId)) {
        selectedReports.delete(reportId);
      } else {
        selectedReports.add(reportId);
      }
      
      updateBulkActions();
    }

    function updateBulkActions() {
      const bulkActions = document.getElementById('bulk-actions');
      const selectedCount = document.getElementById('selected-count');
      
      selectedCount.textContent = selectedReports.size;
      
      if (selectedReports.size > 0) {
        bulkActions.classList.add('show');
      } else {
        bulkActions.classList.remove('show');
      }
    }

    function clearSelection() {
      selectedReports.clear();
      document.querySelectorAll('.report-checkbox').forEach(cb => cb.checked = false);
      document.getElementById('selectAll').checked = false;
      updateBulkActions();
    }

    function viewReportDetails(reportId) {
      const report = floodReports.find(r => r.id === reportId);
      if (!report) return;
      
      currentReportId = reportId;
      
      const modalContent = document.getElementById('reportDetailsContent');
      modalContent.innerHTML = `
        <div class="row">
          <div class="col-md-6">
            <h6 class="text-primary">Location Information</h6>
            <p><strong>Location:</strong> ${report.location}</p>
            <p><strong>Coordinates:</strong> ${report.latitude?.toFixed(6)}, ${report.longitude?.toFixed(6)}</p>
            <p><strong>Reported:</strong> ${formatDateTime(report.timestamp)}</p>
            
            <h6 class="text-primary mt-4">Flood Details</h6>
            <p><strong>Severity:</strong> <span class="severity-badge severity-${report.severity.toLowerCase()}">${report.severity}</span></p>
            <p><strong>Water Depth:</strong> ${report.water_depth}cm</p>
            <p><strong>Current Status:</strong> <span class="status-badge status-${report.status}">${capitalizeFirst(report.status)}</span></p>
            
            <h6 class="text-primary mt-4">Contact Information</h6>
            <p><strong>Reporter:</strong> ${report.contact || 'Not provided'}</p>
          </div>
          <div class="col-md-6">
            <h6 class="text-primary">Description</h6>
            <div class="border rounded p-3 mb-3" style="background-color: #f8f9fa;">
              ${report.description}
            </div>
            
            <h6 class="text-primary">Location Map</h6>
            <div id="detailMap" style="height: 200px; border-radius: 10px;"></div>
          </div>
        </div>
      `;
      
      const modal = new bootstrap.Modal(document.getElementById('reportDetailsModal'));
      modal.show();
      
      // Initialize detail map
      setTimeout(() => {
        if (report.latitude && report.longitude) {
          const detailMap = L.map('detailMap').setView([report.latitude, report.longitude], 16);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(detailMap);
          L.marker([report.latitude, report.longitude]).addTo(detailMap);
        }
      }, 500);
    }

    async function updateReportStatus(reportId, newStatus) {
      try {
        const response = await fetch('/DrainageInventory/api/flood-reports.php', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            id: reportId,
            status: newStatus
          })
        });

        const result = await response.json();

        if (result.success) {
          // Update local data
          const reportIndex = floodReports.findIndex(r => r.id === reportId);
          if (reportIndex !== -1) {
            floodReports[reportIndex].status = newStatus;
            floodReports[reportIndex].updated_at = new Date().toISOString();
          }

          updateStatistics();
          applyFilters();
          
          showNotification(`Report status updated to ${capitalizeFirst(newStatus)}`, 'success');
          
          // Close modal if open
          const modal = bootstrap.Modal.getInstance(document.getElementById('reportDetailsModal'));
          if (modal) modal.hide();
        } else {
          showNotification('Failed to update report status: ' + result.message, 'danger');
        }
      } catch (error) {
        console.error('Error updating report status:', error);
        // Fallback to local update if API fails
        const reportIndex = floodReports.findIndex(r => r.id === reportId);
        if (reportIndex !== -1) {
          floodReports[reportIndex].status = newStatus;
          updateStatistics();
          applyFilters();
          showNotification(`Report status updated to ${capitalizeFirst(newStatus)} (offline mode)`, 'warning');
        } else {
          showNotification('Error updating report status', 'danger');
        }
      }
    }

    async function bulkUpdateStatus(newStatus) {
      const selectedArray = Array.from(selectedReports);
      
      try {
        const updatePromises = selectedArray.map(reportId => 
          updateReportStatusAPI(reportId, newStatus)
        );

        await Promise.all(updatePromises);
        
        // Update local data
        selectedArray.forEach(reportId => {
          const reportIndex = floodReports.findIndex(r => r.id === reportId);
          if (reportIndex !== -1) {
            floodReports[reportIndex].status = newStatus;
            floodReports[reportIndex].updated_at = new Date().toISOString();
          }
        });

        updateStatistics();
        applyFilters();
        clearSelection();
        
        showNotification(`${selectedArray.length} reports updated to ${capitalizeFirst(newStatus)}`, 'success');
      } catch (error) {
        console.error('Error in bulk update:', error);
        showNotification('Some reports failed to update', 'warning');
      }
    }

    async function updateReportStatusAPI(reportId, newStatus) {
      const response = await fetch('/DrainageInventory/api/flood-reports.php', {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          id: reportId,
          status: newStatus
        })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      return response.json();
    }

    async function testDatabaseConnection() {
      try {
        const response = await fetch('/DrainageInventory/api/flood-reports.php');
        const data = await response.json();
        
        if (Array.isArray(data)) {
          console.log('✅ Database connection successful! Loaded', data.length, 'flood reports');
          return true;
        } else {
          console.error('❌ Database connection failed:', data);
          return false;
        }
      } catch (error) {
        console.error('❌ Error connecting to database:', error);
        return false;
      }
    }

    function showOnMap(lat, lng) {
      window.open(`map.html?lat=${lat}&lng=${lng}&zoom=16`, '_blank');
    }

    function exportReports(format) {
      // In a real application, this would call an API endpoint
      showNotification(`Exporting ${filteredReports.length} reports as ${format.toUpperCase()}...`, 'info');
      
      // Simulate export process
      setTimeout(() => {
        showNotification(`Export completed! Download should start automatically.`, 'success');
      }, 2000);
    }

    function refreshReports() {
      showNotification('Refreshing flood reports...', 'info');
      loadFloodReports();
    }

    // Utility functions
    function formatDate(timestamp) {
      return new Date(timestamp).toLocaleDateString();
    }

    function formatTime(timestamp) {
      return new Date(timestamp).toLocaleTimeString();
    }

    function formatDateTime(timestamp) {
      return new Date(timestamp).toLocaleString();
    }

    function capitalizeFirst(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.className = `alert alert-${type} alert-dismissible fade show notification`;
      notification.innerHTML = `
        <i class="fas fa-${getNotificationIcon(type)} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(notification);
      setTimeout(() => {
        if (notification.parentNode) notification.remove();
      }, 5000);
    }

    function getNotificationIcon(type) {
      const icons = {
        success: "check-circle",
        danger: "exclamation-triangle",
        warning: "exclamation-triangle",
        info: "info-circle",
      };
      return icons[type] || "info-circle";
    }
  </script>
</body>
</html>