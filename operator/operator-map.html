<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DrainTrack - Operator Map</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.css" rel="stylesheet">
  <!-- Leaflet MarkerCluster CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.css" rel="stylesheet">
  
  <!-- Unified Design System CSS -->
  <link href="../css/map-common.css" rel="stylesheet">
  
  <style>
    /* Operator-specific additional styles that don't conflict with unified system */
    .operator-stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .operator-stat-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 1rem;
      text-align: center;
      border: 1px solid #e9ecef;
      box-shadow: var(--shadow-md);
      transition: var(--transition-normal);
    }

    .operator-stat-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--success-color);
      margin-bottom: 0.25rem;
    }

    .stat-label {
      font-size: 0.8rem;
      color: #6c757d;
      font-weight: 500;
    }

    .task-card {
      background: white;
      border-radius: var(--border-radius);
      padding: 1rem;
      margin-bottom: 0.75rem;
      border: 1px solid #e9ecef;
      box-shadow: var(--shadow-md);
      transition: var(--transition-normal);
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .task-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: var(--success-color);
      transition: var(--transition-normal);
    }

    .task-card.maintenance-task::before { background: var(--success-color); }
    .task-card.inspection-task::before { background: var(--warning-color); }
    .task-card.priority-high::before, .task-card.priority-critical::before { background: var(--danger-color); }

    .task-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .task-card:hover::before {
      width: 6px;
    }

    .task-title {
      font-weight: 600;
      color: var(--dark-color);
      margin: 0 0 0.25rem 0;
      font-size: 0.95rem;
    }

    .task-location {
      font-size: 0.85rem;
      color: #6c757d;
      margin-bottom: 0.5rem;
    }

    .task-badges {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 0.75rem;
    }

    .task-badge {
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
      border: 1px solid;
    }

    .badge-maintenance {
      background: rgba(56, 161, 105, 0.1);
      color: #38a169;
      border-color: #38a169;
    }

    .badge-inspection {
      background: rgba(237, 137, 54, 0.1);
      color: #ed8936;
      border-color: #ed8936;
    }

    .badge-priority-critical {
      background: rgba(229, 62, 62, 0.1);
      color: #e53e3e;
      border-color: #e53e3e;
    }

    .badge-priority-high {
      background: rgba(253, 126, 20, 0.1);
      color: #fd7e14;
      border-color: #fd7e14;
    }

    .badge-status-pending {
      background: rgba(108, 117, 125, 0.1);
      color: #495057;
      border-color: #6c757d;
    }

    .badge-status-progress {
      background: rgba(23, 162, 184, 0.1);
      color: #17a2b8;
      border-color: #17a2b8;
    }

    .task-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      color: #6c757d;
      margin-bottom: 0.75rem;
    }

    .task-actions {
      display: flex;
      gap: 0.5rem;
    }

    .task-action-btn {
      padding: 0.375rem 0.75rem;
      border: none;
      border-radius: var(--border-radius-sm);
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-normal);
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .btn-task-update {
      background: var(--gradient-operator);
      color: white;
    }

    .btn-task-update:hover {
      transform: translateY(-1px);
    }

    .btn-task-details {
      background: #f8f9fa;
      color: #495057;
      border: 1px solid #dee2e6;
    }

    .btn-task-details:hover {
      background: #e9ecef;
    }

    .performance-indicator {
      background: white;
      border-radius: var(--border-radius);
      padding: 1rem;
      margin-bottom: 1.5rem;
      border: 1px solid #e9ecef;
      box-shadow: var(--shadow-md);
    }

    .performance-metric {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }

    .performance-metric:last-child {
      margin-bottom: 0;
    }

    .metric-label {
      font-size: 0.85rem;
      color: #6c757d;
      font-weight: 500;
    }

    .metric-value {
      font-size: 1rem;
      font-weight: 600;
      color: var(--success-color);
    }

    .progress-bar-custom {
      height: 6px;
      background: #e9ecef;
      border-radius: 3px;
      margin-top: 0.5rem;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--gradient-operator);
      border-radius: 3px;
      transition: width var(--transition-normal);
    }

    .notification-item {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem;
      background: white;
      border-radius: var(--border-radius-sm);
      margin-bottom: 0.5rem;
      border-left: 4px solid var(--success-color);
      box-shadow: var(--shadow-sm);
    }

    .notification-item:last-child {
      margin-bottom: 0;
    }

    .notification-icon {
      color: var(--success-color);
      font-size: 1rem;
      margin-top: 0.25rem;
    }

    .notification-content h6 {
      margin: 0 0 0.25rem 0;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--dark-color);
    }

    .notification-content p {
      margin: 0;
      font-size: 0.8rem;
      color: #6c757d;
    }

    .quick-action-btn {
      background: var(--gradient-operator);
      border: none;
      border-radius: var(--border-radius);
      color: white;
      padding: 0.875rem 1rem;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.75rem;
      transition: var(--transition-normal);
      box-shadow: var(--shadow-md);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      border: none;
      width: 100%;
    }

    .quick-action-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      color: white;
    }

    .quick-action-btn i {
      margin-right: 0.5rem;
    }

    /* Hide edit/delete buttons for operators */
    .operator-restricted {
      display: none !important;
    }

    @media (max-width: 768px) {
      .operator-stats-grid {
        grid-template-columns: 1fr;
      }
      
      .task-actions {
        flex-direction: column;
      }

      .task-action-btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
      }
    }

    @keyframes pulse {
      0% { 
        transform: scale(1); 
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      }
      50% { 
        transform: scale(1.1); 
        box-shadow: 0 4px 12px rgba(0,123,255,0.5);
      }
      100% { 
        transform: scale(1); 
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      }
    }

    .operator-marker-assigned {
      animation: pulse 2s infinite;
    }

    /* Enhanced animation for assigned task markers */
    @keyframes pulse {
      0% { 
        transform: scale(1); 
        opacity: 1;
        box-shadow: 0 0 0 2px #007bff, 0 2px 12px rgba(0,123,255,0.5);
      }
      50% { 
        transform: scale(1.2); 
        opacity: 0.8;
        box-shadow: 0 0 0 4px #007bff, 0 4px 20px rgba(0,123,255,0.7);
      }
      100% { 
        transform: scale(1); 
        opacity: 1;
        box-shadow: 0 0 0 2px #007bff, 0 2px 12px rgba(0,123,255,0.5);
      }
    }

    .assigned-task-marker {
      z-index: 1000 !important;
    }

    .assigned-task-marker div {
      animation: pulse 2s infinite !important;
    }
    
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-container">
      <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;"></div>
      <div class="mt-3 fw-bold">Loading operator map...</div>
    </div>
  </div>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark operator">
    <div class="container-fluid">
      <a class="navbar-brand" href="operator.html">
        <i class="fas fa-water"></i>
        DrainTrack
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link" href="operator.html">
              <i class="fas fa-tachometer-alt me-1"></i>Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="operator-map.html">
              <i class="fas fa-map me-1"></i>Map View
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="operator-tasks.html">
              <i class="fas fa-tasks me-1"></i>Tasks
            </a>
          </li>
        </ul>
        <div class="ms-3">
          <div class="dropdown">
            <a class="btn btn-outline-light dropdown-toggle" href="#" role="button" id="userDropdown" data-bs-toggle="dropdown">
              <i class="fas fa-user-circle me-1"></i><span id="userName">Operator</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>Profile</a></li>
              <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Settings</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <div class="full-screen-container">
    <div class="map-container">
      <!-- Map Element -->
      <div id="map"></div>
      
      <!-- Control Panel -->
      <div class="control-panel" id="controlPanel">
        <div class="control-panel-header operator">
          <h4><i class="fas fa-hard-hat me-2"></i>Operator Control Center</h4>
          <button type="button" class="panel-toggle operator" id="panelToggle" title="Toggle Control Panel">
            <i class="fas fa-chevron-left" id="toggleIcon"></i>
          </button>
        </div>
        
        <div class="control-panel-body">
          <!-- Today's Overview -->
          <div class="content-section operator">
            <h6><i class="fas fa-chart-line me-2"></i>Today's Overview</h6>
            <div class="operator-stats-grid">
              <div class="operator-stat-card">
                <div class="stat-number" id="stat-pending">-</div>
                <div class="stat-label">Pending</div>
              </div>
              <div class="operator-stat-card">
                <div class="stat-number" id="stat-progress">-</div>
                <div class="stat-label">Active</div>
              </div>
              <div class="operator-stat-card">
                <div class="stat-number" id="stat-completed">-</div>
                <div class="stat-label">Completed</div>
              </div>
              <div class="operator-stat-card">
                <div class="stat-number" id="stat-overdue">-</div>
                <div class="stat-label">Overdue</div>
              </div>
            </div>
          </div>

          <!-- Performance Indicator -->
          <div class="performance-indicator">
            <h6><i class="fas fa-trophy me-2"></i>Performance</h6>
            <div class="performance-metric">
              <span class="metric-label">Completion Rate</span>
              <span class="metric-value" id="completion-rate">--%</span>
            </div>
            <div class="progress-bar-custom">
              <div class="progress-fill" id="completion-progress" style="width: 0%"></div>
            </div>
            <div class="performance-metric mt-2">
              <span class="metric-label">Tasks This Week</span>
              <span class="metric-value" id="tasks-week">--</span>
            </div>
          </div>

          <!-- Search Container -->
          <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="form-control" id="search-input" placeholder="Search tasks and locations...">
            <button class="clear-search" id="clear-search-btn" title="Clear search">
              <i class="fas fa-times"></i>
            </button>
            <div class="search-dropdown" id="search-dropdown">
              <!-- Dropdown items will be populated here -->
            </div>
          </div>

          <!-- Quick Filters -->
          <div class="filter-section">
            <h6><i class="fas fa-filter me-2"></i>Quick Filters</h6>
            
            <div class="mb-3">
              <div class="filter-badges">
                <span class="filter-badge operator active" data-filter="all" data-type="view">All Tasks</span>
                <span class="filter-badge operator" data-filter="today" data-type="view">Today</span>
                <span class="filter-badge operator" data-filter="urgent" data-type="view">Urgent</span>
                <span class="filter-badge operator" data-filter="nearby" data-type="view">Nearby</span>
              </div>
            </div>

            <div class="mb-3">
              <div class="filter-badges">
                <span class="filter-badge operator active" data-filter="all" data-type="category">All Types</span>
                <span class="filter-badge operator" data-filter="maintenance" data-type="category">Maintenance</span>
                <span class="filter-badge operator" data-filter="inspection" data-type="category">Inspections</span>
              </div>
            </div>

            <div class="mb-3">
              <div class="filter-badges">
                <span class="filter-badge operator active" data-filter="all" data-type="status">All Status</span>
                <span class="filter-badge operator" data-filter="pending" data-type="status">Pending</span>
                <span class="filter-badge operator" data-filter="progress" data-type="status">In Progress</span>
              </div>
            </div>
          </div>

          <!-- Priority Tasks -->
          <div class="content-section operator">
            <h6><i class="fas fa-exclamation-circle me-2"></i>Priority Tasks</h6>
            <div id="priority-tasks">
              <div class="loading-spinner">
                <div class="spinner-border text-success" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Today's Schedule -->
          <div class="content-section operator">
            <h6><i class="fas fa-calendar-day me-2"></i>Today's Schedule</h6>
            <div id="today-tasks">
              <div class="loading-spinner">
                <div class="spinner-border text-success" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="content-section operator">
            <h6><i class="fas fa-bolt me-2"></i>Quick Actions</h6>
            <button class="quick-action-btn" onclick="showUpdateTaskModal()">
              <i class="fas fa-edit"></i>
              Update Task Status
            </button>
            <button class="quick-action-btn" onclick="showScheduleInspectionModal()">
              <i class="fas fa-clipboard-plus"></i>
              Schedule Inspection
            </button>
            <button class="quick-action-btn" onclick="showReportIssueModal()">
              <i class="fas fa-exclamation-triangle"></i>
              Report Issue
            </button>
            <button class="quick-action-btn" onclick="showWorkLogModal()">
              <i class="fas fa-clock"></i>
              Log Work Hours
            </button>
          </div>

          <!-- Notifications -->
          <div class="content-section operator">
            <h6><i class="fas fa-bell me-2"></i>Notifications</h6>
            <div id="notifications-container">
              <div class="loading-spinner">
                <div class="spinner-border text-success" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Legend -->
          <div class="legend">
            <h6><i class="fas fa-info-circle me-2"></i>Map Legend</h6>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #17a2b8; border: 4px solid #007bff; width: 16px; height: 16px; animation: pulse 2s infinite;"></div>
              <span>My Assigned Task</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #38a169;"></div>
              <span>Good Condition</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #ed8936;"></div>
              <span>Needs Maintenance</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #e53e3e;"></div>
              <span>Critical Condition</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #17a2b8; border: 3px solid #38a169;"></div>
              <span>My Assigned Task</span>
            </div>
            <div class="legend-item">
              <div class="legend-color" style="background-color: #ed8936; border: 3px solid #e53e3e;"></div>
              <span>Overdue Task</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Map Controls -->
      <div class="map-controls">
        <button class="map-control-btn" id="zoom-in-btn" title="Zoom In">
          <i class="fas fa-plus"></i>
        </button>
        <button class="map-control-btn" id="zoom-out-btn" title="Zoom Out">
          <i class="fas fa-minus"></i>
        </button>
        <button class="map-control-btn" id="locate-me-btn" title="My Location">
          <i class="fas fa-location-arrow"></i>
        </button>
        <button class="map-control-btn" id="full-extent-btn" title="Full Extent">
          <i class="fas fa-expand"></i>
        </button>
        <button class="map-control-btn" id="refresh-btn" title="Refresh Data">
          <i class="fas fa-sync-alt"></i>
        </button>
      </div>
      
      <!-- Action Buttons -->
      <div class="action-buttons">
        <button class="action-btn btn-danger-custom" onclick="showFloodReportModal()">
          <i class="fas fa-exclamation-triangle"></i>
          Emergency Report
        </button>
        <button class="action-btn btn-operator" onclick="showUpdateTaskModal()">
          <i class="fas fa-tasks"></i>
          Quick Update
        </button>
      </div>
    </div>
  </div>

  <!-- Point Details Modal (Operator Version - View Only) -->
  <div class="modal fade" id="pointDetailsModal" tabindex="-1" aria-labelledby="pointDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header operator">
          <h5 class="modal-title" id="pointDetailsModalLabel">
            <i class="fas fa-info-circle me-2"></i>Drainage Point Details
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header operator">
                  <h5 class="mb-0"><i class="fas fa-list me-2"></i>General Information</h5>
                </div>
                <div class="card-body">
                  <table class="table table-borderless">
                    <tbody id="point-details-table">
                      <!-- Populated dynamically -->
                    </tbody>
                  </table>
                </div>
              </div>
              
              <div class="card">
                <div class="card-header operator">
                  <h5 class="mb-0"><i class="fas fa-history me-2"></i>Maintenance History</h5>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-sm" id="maintenance-history-table">
                      <!-- Populated dynamically -->
                    </table>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header operator">
                  <h5 class="mb-0"><i class="fas fa-images me-2"></i>Photo Gallery</h5>
                </div>
                <div class="card-body">
                  <div id="point-image-gallery">
                    <!-- Populated dynamically -->
                  </div>
                </div>
              </div>
              
              <div class="card">
                <div class="card-header operator">
                  <h5 class="mb-0"><i class="fas fa-tools me-2"></i>Available Actions</h5>
                </div>
                <div class="card-body">
                  <div class="d-grid gap-2">
                    <button class="btn btn-outline-success" onclick="showScheduleInspectionModal(currentPointId)">
                      <i class="fas fa-clipboard-check me-2"></i>Schedule Inspection
                    </button>
                    <button class="btn btn-outline-warning" onclick="showRequestMaintenanceModal(currentPointId)">
                      <i class="fas fa-wrench me-2"></i>Request Maintenance
                    </button>
                    <button class="btn btn-outline-info" onclick="downloadPointReport(currentPointId)">
                      <i class="fas fa-download me-2"></i>Download Report
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <!-- Edit and Delete buttons are hidden for operators -->
        </div>
      </div>
    </div>
  </div>

  <!-- View Details Modal (Operator - View Only) -->
  <div class="modal fade" id="viewDetailsModal" tabindex="-1" aria-labelledby="viewDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header operator">
          <h5 class="modal-title" id="viewDetailsModalLabel">
            <i class="fas fa-info-circle me-2"></i>Drainage Point Details
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header operator">
                  <h5 class="mb-0"><i class="fas fa-list me-2"></i>General Information</h5>
                </div>
                <div class="card-body">
                  <table class="table table-borderless">
                    <tbody id="view-details-table">
                      <!-- Populated dynamically -->
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="card">
                <div class="card-header operator">
                  <h5 class="mb-0"><i class="fas fa-history me-2"></i>Maintenance History</h5>
                </div>
                <div class="card-body">
                  <div class="table-responsive">
                    <table class="table table-sm" id="view-maintenance-history-table">
                      <!-- Populated dynamically -->
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card mb-3">
                <div class="card-header operator">
                  <h5 class="mb-0"><i class="fas fa-images me-2"></i>Photo Gallery</h5>
                </div>
                <div class="card-body">
                  <div id="view-point-image-gallery">
                    <!-- Populated dynamically -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Task Update Modal -->
  <div class="modal fade" id="updateTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header operator">
          <h5 class="modal-title">
            <i class="fas fa-edit me-2"></i>Update Task Status
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="updateTaskForm">
            <div class="mb-3">
              <label for="task-select" class="form-label">Select Task</label>
              <select class="form-select" id="task-select" required>
                <option value="">Choose a task...</option>
              </select>
            </div>
            
            <div class="mb-3" id="task-info-display" style="display: none;">
              <div class="alert alert-info" id="task-info-content"></div>
            </div>
            
            <div class="mb-3">
              <label for="task-status" class="form-label">New Status</label>
              <select class="form-select" id="task-status" required>
                <option value="">Select status...</option>
                <option value="In Progress">In Progress</option>
                <option value="Completed">Completed</option>
                <option value="On Hold">On Hold</option>
              </select>
            </div>
            
            <div class="mb-3" id="inspection-fields" style="display: none;">
              <label for="inspection-findings" class="form-label">Inspection Findings</label>
              <textarea class="form-control" id="inspection-findings" rows="3" 
                        placeholder="Describe your inspection findings..."></textarea>
            </div>
            
            <div class="mb-3" id="inspection-recommendations" style="display: none;">
              <label for="recommendations" class="form-label">Recommendations</label>
              <textarea class="form-control" id="recommendations" rows="2" 
                        placeholder="Any recommendations for maintenance or follow-up..."></textarea>
            </div>
            
            <div class="mb-3">
              <label for="task-notes" class="form-label">Progress Notes</label>
              <textarea class="form-control" id="task-notes" rows="3" 
                        placeholder="Describe work completed, issues encountered, etc."></textarea>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="hours-worked" class="form-label">Hours Worked</label>
                  <input type="number" class="form-control" id="hours-worked" step="0.5" min="0" 
                         placeholder="0.0">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="completion-percentage" class="form-label">Completion %</label>
                  <input type="number" class="form-control" id="completion-percentage" min="0" max="100" 
                         placeholder="0">
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" onclick="updateTaskStatus()">
            <i class="fas fa-save me-1"></i>Update Task
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Request Maintenance Modal -->
  <div class="modal fade" id="requestMaintenanceModal" tabindex="-1" aria-labelledby="requestMaintenanceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title" id="requestMaintenanceModalLabel">
            <i class="fas fa-wrench me-2"></i>Request Maintenance
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="maintenance-request-form">
            <input type="hidden" id="maintenance-drainage-point-id" name="drainage_point_id">
            
            <div class="mb-3">
              <label for="maintenance-point-name" class="form-label">Drainage Point</label>
              <input type="text" class="form-control" id="maintenance-point-name" readonly>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="maintenance-type" class="form-label">Maintenance Type *</label>
                  <select class="form-select" id="maintenance-type" required>
                    <option value="">Select maintenance type</option>
                    <option value="Cleaning">Cleaning</option>
                    <option value="Repair">Repair</option>
                    <option value="Replacement">Replacement</option>
                    <option value="Inspection">Inspection</option>
                    <option value="Upgrade">Upgrade</option>
                    <option value="Emergency Repair">Emergency Repair</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="maintenance-priority" class="form-label">Priority *</label>
                  <select class="form-select" id="maintenance-priority" required>
                    <option value="Low">Low</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="High">High</option>
                    <option value="Critical">Critical</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="maintenance-description" class="form-label">Description *</label>
              <textarea class="form-control" id="maintenance-description" rows="4" required 
                        placeholder="Describe the issue and required maintenance work..."></textarea>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="maintenance-estimated-cost" class="form-label">Estimated Cost (RM)</label>
                  <input type="number" class="form-control" id="maintenance-estimated-cost" 
                         step="0.01" min="0" placeholder="0.00">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="maintenance-scheduled-date" class="form-label">Preferred Date</label>
                  <input type="date" class="form-control" id="maintenance-scheduled-date">
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="maintenance-assigned-to" class="form-label">Assign To</label>
              <select class="form-select" id="maintenance-assigned-to">
                <option value="">Select team member (optional)</option>
                <!-- Will be populated dynamically -->
              </select>
            </div>
            
            <div class="mb-3">
              <label for="maintenance-notes" class="form-label">Additional Notes</label>
              <textarea class="form-control" id="maintenance-notes" rows="2" 
                        placeholder="Any additional information or special requirements..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-warning" id="submit-maintenance-request-btn">
            <i class="fas fa-paper-plane me-1"></i>Submit Request
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Schedule Inspection Modal -->
  <div class="modal fade" id="scheduleInspectionModal" tabindex="-1" aria-labelledby="scheduleInspectionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-success">
          <h5 class="modal-title" id="scheduleInspectionModalLabel">
            <i class="fas fa-clipboard-check me-2"></i>Schedule Inspection
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="inspection-schedule-form">
            <input type="hidden" id="inspection-drainage-point-id" name="drainage_point_id">
            
            <div class="mb-3">
              <label for="inspection-point-name" class="form-label">Drainage Point</label>
              <input type="text" class="form-control" id="inspection-point-name" readonly>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="inspection-type" class="form-label">Inspection Type *</label>
                  <select class="form-select" id="inspection-type" required>
                    <option value="">Select inspection type</option>
                    <option value="Routine Inspection">Routine Inspection</option>
                    <option value="Safety Inspection">Safety Inspection</option>
                    <option value="Structural Inspection">Structural Inspection</option>
                    <option value="Emergency Inspection">Emergency Inspection</option>
                    <option value="Post-Maintenance Inspection">Post-Maintenance Inspection</option>
                    <option value="Compliance Inspection">Compliance Inspection</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="inspection-priority" class="form-label">Priority *</label>
                  <select class="form-select" id="inspection-priority" required>
                    <option value="Low">Low</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="High">High</option>
                    <option value="Critical">Critical</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="inspection-scheduled-date" class="form-label">Scheduled Date *</label>
                  <input type="date" class="form-control" id="inspection-scheduled-date" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="inspection-scheduled-time" class="form-label">Scheduled Time</label>
                  <input type="time" class="form-control" id="inspection-scheduled-time">
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="inspection-description" class="form-label">Description</label>
              <textarea class="form-control" id="inspection-description" rows="3" 
                        placeholder="Describe the purpose and scope of this inspection..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="submit-inspection-schedule-btn">
            <i class="fas fa-calendar-plus me-1"></i>Schedule Inspection
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Task Completion Report Modal -->
  <div class="modal fade" id="completionReportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-success">
          <h5 class="modal-title text-white">
            <i class="fas fa-check-circle me-2"></i>Complete Task - Final Report
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-success">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Task Completion:</strong> Please provide comprehensive details about the completed work for documentation and quality assurance.
          </div>
          
          <form id="completionReportForm">
            <input type="hidden" id="completion-task-id" name="task_id">
            
            <!-- Task Summary -->
            <div class="row mb-4">
              <div class="col-12">
                <div class="card">
                  <div class="card-header bg-light">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Task Summary</h6>
                  </div>
                  <div class="card-body">
                    <div id="completion-task-summary">
                      <!-- Populated dynamically -->
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Completion Details -->
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="completion-start-time" class="form-label">Work Start Time</label>
                  <input type="datetime-local" class="form-control" id="completion-start-time" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="completion-end-time" class="form-label">Work End Time</label>
                  <input type="datetime-local" class="form-control" id="completion-end-time" required>
                </div>
              </div>
            </div>
            
            <div class="row mb-4">
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="completion-hours" class="form-label">Total Hours Worked</label>
                  <input type="number" class="form-control" id="completion-hours" step="0.5" min="0" required>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="completion-materials-cost" class="form-label">Materials Cost (RM)</label>
                  <input type="number" class="form-control" id="completion-materials-cost" step="0.01" min="0" placeholder="0.00">
                </div>
              </div>
              
              </div>
            
            
            <!-- Work Description -->
            <div class="mb-4">
              <label for="completion-work-description" class="form-label">Work Performed Description *</label>
              <textarea class="form-control" id="completion-work-description" rows="4" required 
                        placeholder="Describe in detail what work was performed, methods used, and any challenges encountered..."></textarea>
            </div>
            
            <!-- Inspection Findings (for inspection tasks) -->
            <div id="completion-inspection-section" style="display: none;">
              <div class="mb-4">
                <label for="completion-inspection-findings" class="form-label">Detailed Inspection Findings</label>
                <textarea class="form-control" id="completion-inspection-findings" rows="3" 
                          placeholder="Document all findings from the inspection..."></textarea>
              </div>
              
              <div class="mb-4">
                <label for="completion-recommendations" class="form-label">Recommendations</label>
                <textarea class="form-control" id="completion-recommendations" rows="3" 
                          placeholder="Provide recommendations for future maintenance, monitoring, or improvements..."></textarea>
              </div>
            </div>
            
            <!-- Issues Encountered -->
            <div class="mb-4">
              <label for="completion-issues" class="form-label">Issues or Complications</label>
              <textarea class="form-control" id="completion-issues" rows="2" 
                        placeholder="Document any issues, delays, or complications encountered (or write 'None' if no issues)..."></textarea>
            </div>
            
            <!-- Materials and Equipment Used -->
            <div class="row mb-4">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="completion-materials" class="form-label">Materials Used</label>
                  <textarea class="form-control" id="completion-materials" rows="3" 
                            placeholder="List all materials used with quantities..."></textarea>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="completion-equipment" class="form-label">Equipment Used</label>
                  <textarea class="form-control" id="completion-equipment" rows="3" 
                            placeholder="List all equipment and tools used..."></textarea>
                </div>
              </div>
            </div>
            
            <!-- Follow-up Required -->
            <div class="mb-4">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="completion-followup-required">
                <label class="form-check-label" for="completion-followup-required">
                  Follow-up work required
                </label>
              </div>
              <div id="completion-followup-details" style="display: none;" class="mt-2">
                <label for="completion-followup-description" class="form-label">Follow-up Details</label>
                <textarea class="form-control" id="completion-followup-description" rows="2" 
                          placeholder="Describe what follow-up work is needed and when..."></textarea>
              </div>
            </div>
            
            <!-- Photo Documentation -->
            <div class="mb-4">
              <div class="card">
                <div class="card-header">
                  <h6 class="mb-0"><i class="fas fa-camera me-2"></i>Photo Documentation</h6>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label for="completion-photos" class="form-label">Upload Completion Photos</label>
                    <input type="file" class="form-control" id="completion-photos" multiple accept="image/jpeg,image/jpg,image/png">
                    <div class="form-text">
                      <i class="fas fa-info-circle me-1"></i>
                      Upload before/after photos, work in progress, and final results. Supported formats: JPG, PNG. Max 5MB per image.
                    </div>
                  </div>
                  
                  <div id="completion-photo-preview" class="row g-2" style="display: none;">
                    <!-- Photo previews will be added here -->
                  </div>
                  
                  <div class="mb-3">
                    <label for="completion-photo-description" class="form-label">Photo Description</label>
                    <textarea class="form-control" id="completion-photo-description" rows="2" 
                              placeholder="Describe what the photos show..."></textarea>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Final Verification -->
            <div class="mb-4">
              <div class="card border-success">
                <div class="card-header bg-light">
                  <h6 class="mb-0 text-success"><i class="fas fa-check-circle me-2"></i>Final Verification</h6>
                </div>
                <div class="card-body">
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="completion-verify-work" required>
                    <label class="form-check-label" for="completion-verify-work">
                      I confirm that all work has been completed according to specifications
                    </label>
                  </div>
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="completion-verify-safety" required>
                    <label class="form-check-label" for="completion-verify-safety">
                      All safety protocols were followed during the work
                    </label>
                  </div>
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="completion-verify-cleanup" required>
                    <label class="form-check-label" for="completion-verify-cleanup">
                      Work area has been properly cleaned and secured
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="completion-verify-documentation" required>
                    <label class="form-check-label" for="completion-verify-documentation">
                      All required documentation has been completed accurately
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" onclick="submitCompletionReport()" id="submit-completion-btn">
            <i class="fas fa-check-double me-1"></i>Complete Task & Submit Report
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Flood Report Modal -->
  <div class="modal fade" id="floodReportModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger">
          <h5 class="modal-title text-white">
            <i class="fas fa-exclamation-triangle me-2"></i>Emergency Flood Report
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-warning">
            <i class="fas fa-info-circle me-2"></i>
            Use this for immediate flood situations requiring urgent response.
          </div>
          <form id="floodReportForm">
            <div class="mb-3">
              <label for="flood-location" class="form-label">Location</label>
              <input type="text" class="form-control" id="flood-location" required 
                     placeholder="Enter specific location description">
            </div>
            
            <div class="mb-3">
              <label for="flood-severity" class="form-label">Severity</label>
              <select class="form-select" id="flood-severity" required>
                <option value="">Select severity...</option>
                <option value="Minor">Minor - Small puddles</option>
                <option value="Moderate">Moderate - Road partially blocked</option>
                <option value="Severe">Severe - Road impassable</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="flood-description" class="form-label">Description</label>
              <textarea class="form-control" id="flood-description" rows="3" required
                        placeholder="Describe the flooding situation in detail..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" onclick="submitFloodReport()">
            <i class="fas fa-paper-plane me-1"></i>Submit Emergency Report
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="imageUploadModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header operator">
          <h5 class="modal-title">
            <i class="fas fa-camera me-2"></i>Add Inspection Photos
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <strong>Inspection Documentation:</strong> Upload photos to document your inspection findings. These images will be added to the point's gallery.
          </div>
          
          <form id="imageUploadForm" enctype="multipart/form-data">
            <div class="mb-3">
              <label for="inspection-images" class="form-label">Select Images</label>
              <input type="file" class="form-control" id="inspection-images" multiple accept="image/jpeg,image/jpg,image/png" required>
              <div class="form-text">
                <i class="fas fa-info-circle me-1"></i>
                Supported formats: JPG, PNG. Maximum file size: 5MB per image.
              </div>
            </div>
            
            <div class="mb-3" id="image-preview-container" style="display: none;">
              <label class="form-label">Preview</label>
              <div id="preview-images" class="row g-2"></div>
            </div>
            
            <div class="mb-3">
              <label for="image-description" class="form-label">Description (Optional)</label>
              <textarea class="form-control" id="image-description" rows="3" 
                        placeholder="Describe what the images show (e.g., condition findings, specific issues observed...)"></textarea>
            </div>
            
            <div class="mb-3">
              <label for="image-category" class="form-label">Category</label>
              <select class="form-select" id="image-category">
                <option value="inspection">Inspection Documentation</option>
                <option value="before">Before Maintenance</option>
                <option value="during">During Work</option>
                <option value="after">After Maintenance</option>
                <option value="issue">Issue Documentation</option>
                <option value="general">General</option>
              </select>
            </div>
          </form>
          
          <div id="upload-progress" style="display: none;">
            <div class="mb-2">
              <strong>Uploading images...</strong>
            </div>
            <div class="progress">
              <div class="progress-bar" role="progressbar" style="width: 0%" id="upload-progress-bar"></div>
            </div>
            <div class="mt-2">
              <span id="upload-status">Preparing upload...</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" onclick="uploadInspectionImages()" id="upload-images-btn">
            <i class="fas fa-upload me-1"></i>Upload Images
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.3/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>

  <script src="../js/operator-map.js"></script>
   
</body>
</html>