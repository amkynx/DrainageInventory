<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DrainTrack - Operator Dashboard</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Chart.js for data visualization -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <!-- Common DrainTrack Styles -->
  <link href="../css/common.css" rel="stylesheet">
  
  <style>
    /* Task Card Styles - Integrated with common.css */
    .task-card {
      background: white;
      border-radius: var(--border-radius-sm);
      box-shadow: var(--shadow-md);
      border: none;
      border-left: 4px solid var(--success-color);
      margin-bottom: 1rem;
      padding: 1.25rem;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .task-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    .task-card.inspection-task {
      border-left-color: var(--warning-color);
    }

    .task-card.priority-high, 
    .task-card.priority-critical {
      border-left-color: var(--danger-color);
    }

    .task-card.priority-medium {
      border-left-color: var(--warning-color);
    }

    .task-card.priority-low {
      border-left-color: var(--success-color);
    }

    .task-card.assigned-to-me {
      border: 2px solid var(--primary-color);
      background: rgba(74, 85, 104, 0.02);
    }

    .task-card.assigned-to-me::before {
      content: '';
      position: absolute;
      top: 10px;
      right: 10px;
      width: 8px;
      height: 8px;
      background: var(--primary-color);
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .task-title {
      font-weight: 600;
      color: var(--dark-color);
      margin: 0 0 0.5rem 0;
      font-size: 1rem;
      line-height: 1.4;
    }

    .task-location {
      font-size: 0.9rem;
      color: var(--secondary-color);
      margin-bottom: 1rem;
    }

    .task-badges {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .task-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 500;
      border: 1px solid;
    }

    .task-badge.badge-maintenance {
      background: rgba(56, 161, 105, 0.1);
      color: var(--success-color);
      border-color: var(--success-color);
    }

    .task-badge.badge-inspection {
      background: rgba(237, 137, 54, 0.1);
      color: var(--warning-color);
      border-color: var(--warning-color);
    }

    .task-badge.badge-priority-critical {
      background: rgba(229, 62, 62, 0.1);
      color: var(--danger-color);
      border-color: var(--danger-color);
    }

    .task-badge.badge-priority-high {
      background: rgba(253, 126, 20, 0.1);
      color: #fd7e14;
      border-color: #fd7e14;
    }

    .task-badge.badge-priority-medium {
      background: rgba(237, 137, 54, 0.1);
      color: var(--warning-color);
      border-color: var(--warning-color);
    }

    .task-badge.badge-priority-low {
      background: rgba(56, 161, 105, 0.1);
      color: var(--success-color);
      border-color: var(--success-color);
    }

    .task-badge.badge-status-pending {
      background: rgba(108, 117, 125, 0.1);
      color: var(--secondary-color);
      border-color: var(--secondary-color);
    }

    .task-badge.badge-status-scheduled {
      background: rgba(74, 85, 104, 0.1);
      color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .task-badge.badge-status-in-progress {
      background: rgba(49, 130, 206, 0.1);
      color: #3182ce;
      border-color: #3182ce;
    }

    .task-badge.badge-status-completed {
      background: rgba(56, 161, 105, 0.1);
      color: var(--success-color);
      border-color: var(--success-color);
    }

    .task-badge.bg-info {
      background: rgba(49, 130, 206, 0.1) !important;
      color: #3182ce !important;
      border-color: #3182ce;
    }

    .task-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
      color: var(--secondary-color);
      margin-bottom: 1rem;
    }

    .task-meta span {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .task-actions {
      display: flex;
      gap: 0.5rem;
    }

    .task-action-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: var(--border-radius-sm);
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      text-decoration: none;
    }

    .btn-task-update {
      background: var(--gradient-primary);
      color: white;
    }

    .btn-task-update:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
      color: white;
    }

    .btn-task-details {
      background: #f8f9fa;
      color: var(--secondary-color);
      border: 1px solid #dee2e6;
    }

    .btn-task-details:hover {
      background: #e9ecef;
      color: var(--dark-color);
    }

    /* Quick Action Button Fixes */
    .quick-action-btn {
      background: var(--gradient-primary) !important;
      border: none !important;
      border-radius: var(--border-radius-sm) !important;
      color: white !important;
      padding: 1rem 1.5rem !important;
      text-decoration: none !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      margin-bottom: 1rem !important;
      transition: all 0.3s ease !important;
      box-shadow: var(--shadow-md) !important;
      width: 100% !important;
      cursor: pointer !important;
      font-size: 0.95rem !important;
      font-weight: 500 !important;
      gap: 0.5rem !important;
    }

    .quick-action-btn:hover {
      transform: translateY(-2px) !important;
      box-shadow: var(--shadow-lg) !important;
      color: white !important;
      text-decoration: none !important;
    }

    /* Today's Schedule Styling */
    .today-schedule {
      background: var(--gradient-success);
      color: white;
      border-radius: var(--border-radius);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: var(--shadow-md);
    }

    .schedule-item {
      background: rgba(255,255,255,0.1);
      border-radius: var(--border-radius-sm);
      padding: 1rem;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .schedule-time {
      font-weight: 600;
      font-size: 1.1rem;
    }

    /* Inspection Status Indicators */
    .inspection-status {
      font-size: 0.8rem;
      padding: 0.25rem 0.75rem;
      border-radius: 20px;
      font-weight: 500;
    }

    .inspection-status.scheduled {
      background-color: rgba(74, 85, 104, 0.1);
      color: var(--primary-color);
    }

    .inspection-status.in-progress {
      background-color: rgba(237, 137, 54, 0.1);
      color: var(--warning-color);
    }

    .inspection-status.completed {
      background-color: rgba(56, 161, 105, 0.1);
      color: var(--success-color);
    }

    .inspection-status.pending {
      background-color: rgba(108, 117, 125, 0.1);
      color: var(--secondary-color);
    }

    .inspection-status.overdue {
      background-color: rgba(229, 62, 62, 0.1);
      color: var(--danger-color);
    }

    /* Notification Items */
    .notification-item {
      padding: 1rem;
      border-bottom: 1px solid #e9ecef;
      transition: background-color 0.3s ease;
      cursor: pointer;
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
    }

    .notification-item:hover {
      background-color: #f8f9fa;
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notification-item.unread {
      background-color: rgba(74, 85, 104, 0.05);
      border-left: 3px solid var(--primary-color);
    }

    .notification-icon {
      color: var(--primary-color);
      font-size: 1rem;
      margin-top: 0.25rem;
    }

    .notification-content h6 {
      margin: 0 0 0.25rem 0;
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--dark-color);
    }

    .notification-content p {
      margin: 0;
      font-size: 0.85rem;
      color: var(--secondary-color);
    }

    /* Task Tabs */
    .task-tabs {
      margin-bottom: 1.5rem;
    }

    .task-tabs .nav-link {
      border: none;
      border-radius: var(--border-radius-sm);
      margin-right: 0.5rem;
      padding: 0.75rem 1.5rem;
      transition: all 0.3s ease;
      font-weight: 500;
    }

    .task-tabs .nav-link.active {
      background: var(--gradient-primary);
      color: white;
    }

    .task-tabs .nav-link:not(.active) {
      background: #f8f9fa;
      color: var(--secondary-color);
    }

    .task-tabs .nav-link:not(.active):hover {
      background: #e9ecef;
      color: var(--primary-color);
    }

    /* Performance section */
    .performance-summary {
      text-align: center;
    }

    .performance-summary h4 {
      color: var(--primary-color);
      margin-bottom: 0.25rem;
    }

    .performance-summary .progress {
      height: 8px;
      border-radius: 10px;
      background: #f8f9fa;
    }

    .performance-summary .progress-bar {
      background: var(--gradient-success);
      border-radius: 10px;
    }

    /* Chart Container */
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .task-card {
        margin-bottom: 1rem;
        padding: 1rem;
      }
      
      .today-schedule {
        padding: 1rem;
      }
      
      .schedule-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
      }

      .task-actions {
        flex-direction: column;
      }

      .task-action-btn {
        font-size: 0.8rem;
        padding: 0.4rem 0.8rem;
      }

      .task-badges {
        gap: 0.25rem;
      }

      .task-badge {
        font-size: 0.7rem;
        padding: 0.2rem 0.5rem;
      }
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner-container">
      <div class="spinner-border loading-spinner" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <h4>Loading Dashboard...</h4>
      <p>Please wait while we prepare your workspace</p>
    </div>
  </div>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="operator.html">
        <i class="fas fa-water"></i>
        DrainTrack
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link active" href="operator.html">
              <i class="fas fa-tachometer-alt me-1"></i>Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="operator-map.html">
              <i class="fas fa-map me-1"></i>Drainage Map
            </a>
          </li>
        </ul>
        <div class="ms-3">
          <div class="dropdown">
            <a class="btn btn-outline-light dropdown-toggle" href="#" role="button" id="userDropdown" data-bs-toggle="dropdown">
              <i class="fas fa-user-circle me-1"></i><span id="userName">Operator</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="main-content">
    <div class="container-fluid">
      <!-- Page Header -->
      <div class="row mb-4">
        <div class="col-12">
          <h1 class="h2 mb-3 text-gradient">
            <i class="fas fa-hard-hat me-2"></i>
            Operator Dashboard
          </h1>
          <p class="text-muted">Welcome back! Manage your assigned maintenance tasks and inspections.</p>
        </div>
      </div>

      <!-- Statistics Cards -->
      <div class="row mb-4">
        <div class="col-xl-2 col-md-4 col-sm-6">
          <div class="card stats-card position-relative animate-slide-in">
            <div class="stats-number" id="total-tasks">0</div>
            <div class="stats-label">My Total Tasks</div>
            <i class="fas fa-tasks stats-icon"></i>
          </div>
        </div>
        <div class="col-xl-2 col-md-4 col-sm-6">
          <div class="card stats-card warning position-relative animate-slide-in">
            <div class="stats-number" id="pending-tasks">0</div>
            <div class="stats-label">My Pending</div>
            <i class="fas fa-clock stats-icon"></i>
          </div>
        </div>
        <div class="col-xl-2 col-md-4 col-sm-6">
          <div class="card stats-card info position-relative animate-slide-in">
            <div class="stats-number" id="in-progress-tasks">0</div>
            <div class="stats-label">My In Progress</div>
            <i class="fas fa-cog stats-icon"></i>
          </div>
        </div>
        <div class="col-xl-2 col-md-4 col-sm-6">
          <div class="card stats-card position-relative animate-slide-in">
            <div class="stats-number" id="inspection-tasks">0</div>
            <div class="stats-label">My Inspections</div>
            <i class="fas fa-clipboard-check stats-icon"></i>
          </div>
        </div>
        <div class="col-xl-2 col-md-4 col-sm-6">
          <div class="card stats-card success position-relative animate-slide-in">
            <div class="stats-number" id="completed-tasks">0</div>
            <div class="stats-label">My Completed</div>
            <i class="fas fa-check-circle stats-icon"></i>
          </div>
        </div>
        <div class="col-xl-2 col-md-4 col-sm-6">
          <div class="card stats-card danger position-relative animate-slide-in">
            <div class="stats-number" id="overdue-tasks">0</div>
            <div class="stats-label">My Overdue</div>
            <i class="fas fa-exclamation-triangle stats-icon"></i>
          </div>
        </div>
      </div>

      <!-- Main Dashboard Content -->
      <div class="row">
        <!-- Left Column -->
        <div class="col-xl-8">
          <!-- Today's Schedule -->
          <div class="today-schedule">
            <h4 class="mb-3">
              <i class="fas fa-calendar-day me-2"></i>
              My Schedule for Today
            </h4>
            <div id="today-schedule-list">
              <div class="text-center py-3">
                <div class="spinner-border" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Task Management -->
          <div class="card dashboard-card animate-fade-in">
            <div class="card-header-custom">
              <i class="fas fa-list-check"></i>
              My Tasks & Inspections
              <small class="text-muted ms-2">(<span id="user-task-count">0</span> assigned to me)</small>
            </div>
            <div class="card-body">
              <!-- Task Tabs -->
              <ul class="nav nav-pills task-tabs" id="taskTabs" role="tablist">
                <li class="nav-item" role="presentation">
                  <button class="nav-link active" id="all-tasks-tab" data-bs-toggle="pill" data-bs-target="#all-tasks" type="button" role="tab">
                    <i class="fas fa-list me-1"></i>My Tasks
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="maintenance-tab" data-bs-toggle="pill" data-bs-target="#maintenance" type="button" role="tab">
                    <i class="fas fa-tools me-1"></i>My Maintenance
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="inspections-tab" data-bs-toggle="pill" data-bs-target="#inspections" type="button" role="tab">
                    <i class="fas fa-clipboard-check me-1"></i>My Inspections
                  </button>
                </li>
                <li class="nav-item" role="presentation">
                  <button class="nav-link" id="today-tab" data-bs-toggle="pill" data-bs-target="#today" type="button" role="tab">
                    <i class="fas fa-calendar-day me-1"></i>Due Today
                  </button>
                </li>
              </ul>

              <!-- Tab Content -->
              <div class="tab-content" id="taskTabContent">
                <div class="tab-pane fade show active" id="all-tasks" role="tabpanel">
                  <div id="all-tasks-list">
                    <div class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="tab-pane fade" id="maintenance" role="tabpanel">
                  <div id="maintenance-tasks-list">
                    <div class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="tab-pane fade" id="inspections" role="tabpanel">
                  <div id="inspection-tasks-list">
                    <div class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="tab-pane fade" id="today" role="tabpanel">
                  <div id="today-tasks-list">
                    <div class="text-center py-4">
                      <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Work Progress Chart -->
          <div class="card dashboard-card animate-fade-in">
            <div class="card-header-custom">
              <i class="fas fa-chart-line"></i>
              My Work Progress This Month
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="workProgressChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column -->
        <div class="col-xl-4">
          <!-- Quick Actions -->
          <div class="card dashboard-card animate-fade-in">
            <div class="card-header-custom">
              <i class="fas fa-bolt"></i>
              Quick Actions
            </div>
            <div class="card-body">
              <button type="button" class="quick-action-btn" onclick="showUpdateTaskModal()">
                <i class="fas fa-edit me-2"></i>
                Update My Task Status
              </button>
              <button type="button" class="quick-action-btn" onclick="showReportIssueModal()">
                <i class="fas fa-exclamation-circle me-2"></i>
                Report Issue
              </button>
              <button type="button" class="quick-action-btn" onclick="showWorkLogModal()">
                <i class="fas fa-clipboard-list me-2"></i>
                Log Work Hours
              </button>
            </div>
          </div>

          <!-- Notifications -->
          <div class="card dashboard-card animate-fade-in">
            <div class="card-header-custom">
              <i class="fas fa-bell"></i>
              My Notifications
              <span class="badge bg-light text-primary ms-2" id="unread-count">0</span>
            </div>
            <div class="card-body p-0" style="max-height: 300px; overflow-y: auto;">
              <div id="notifications-list">
                <div class="text-center py-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>


          <!-- Recent Activities -->
          <div class="card dashboard-card animate-fade-in">
            <div class="card-header-custom">
              <i class="fas fa-history"></i>
              Recent Activities
            </div>
            <div class="card-body">
              <div id="recent-activities-list">
                <div class="text-center py-3">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          
          <!-- Performance Summary -->
          <div class="card dashboard-card animate-fade-in">
            <div class="card-header-custom">
              <i class="fas fa-chart-line"></i>
              My Performance This Month
            </div>
            <div class="card-body performance-summary">
              <div class="row text-center">
                <div class="col-6">
                  <h4 id="month-completed">0</h4>
                  <small class="text-muted">Completed</small>
                </div>
                <div class="col-6">
                  <h4 id="month-efficiency">0%</h4>
                  <small class="text-muted">On Time</small>
                </div>
              </div>
              <div class="progress mt-3">
                <div class="progress-bar" role="progressbar" style="width: 0%" id="efficiency-bar">0%</div>
              </div>
              <small class="text-muted">Overall Efficiency</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Task Update Modal -->
  <div class="modal fade" id="updateTaskModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fas fa-edit me-2"></i>Update My Task Status
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="updateTaskForm">
            <div class="mb-3">
              <label for="task-select" class="form-label">Select My Task</label>
              <select class="form-select" id="task-select" required>
                <option value="">Choose one of my tasks...</option>
              </select>
            </div>
            
            <div class="mb-3" id="task-type-display" style="display: none;">
              <label class="form-label">Task Type</label>
              <div id="task-type-info" class="bg-light p-3 rounded"></div>
            </div>
            
            <div class="mb-3">
              <label for="task-status" class="form-label">New Status</label>
              <select class="form-select" id="task-status" required>
                <option value="">Select status...</option>
                <option value="In Progress">In Progress</option>
                <option value="Completed">Completed</option>
                <option value="On Hold">On Hold</option>
              </select>
            </div>
            
            <div class="mb-3" id="inspection-fields" style="display: none;">
              <label for="inspection-findings" class="form-label">Inspection Findings *</label>
              <textarea class="form-control" id="inspection-findings" rows="3" 
                        placeholder="Describe your inspection findings..."></textarea>
            </div>
            
            <div class="mb-3" id="inspection-recommendations" style="display: none;">
              <label for="recommendations" class="form-label">Recommendations</label>
              <textarea class="form-control" id="recommendations" rows="2" 
                        placeholder="Any recommendations for maintenance or follow-up..."></textarea>
            </div>

            <div class="row" id="inspection-condition-fields" style="display: none;">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="condition-rating" class="form-label">Overall Condition</label>
                  <select class="form-select" id="condition-rating">
                    <option value="Excellent">Excellent</option>
                    <option value="Good" selected>Good</option>
                    <option value="Fair">Fair</option>
                    <option value="Poor">Poor</option>
                    <option value="Critical">Critical</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="maintenance-required" class="form-label">Maintenance Required</label>
                  <select class="form-select" id="maintenance-required">
                    <option value="false">No</option>
                    <option value="true">Yes</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="form-check mb-3" id="maintenance-request-option" style="display: none;">
              <input class="form-check-input" type="checkbox" id="create-maintenance-request">
              <label class="form-check-label" for="create-maintenance-request">
                Create maintenance request based on findings
              </label>
            </div>
            
            <div class="mb-3">
              <label for="task-notes" class="form-label">Progress Notes</label>
              <textarea class="form-control" id="task-notes" rows="3" 
                        placeholder="Describe work completed, issues encountered, etc."></textarea>
            </div>
            
            <div class="mb-3">
              <label for="task-images" class="form-label">Upload Photos</label>
              <input type="file" class="form-control" id="task-images" multiple accept="image/*">
              <div class="form-text">Upload photos of work progress or completed tasks</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="updateTaskStatus()">
            <i class="fas fa-save me-1"></i>Update Task
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Issue Modal -->
  <div class="modal fade" id="reportIssueModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title text-dark">
            <i class="fas fa-exclamation-circle me-2"></i>Report Issue
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="reportIssueForm">
            <div class="mb-3">
              <label for="issue-location" class="form-label">Location *</label>
              <input type="text" class="form-control" id="issue-location" required 
                     placeholder="Enter specific location or drainage point name">
            </div>
            
            <div class="mb-3">
              <label for="issue-type" class="form-label">Issue Type *</label>
              <select class="form-select" id="issue-type" required>
                <option value="">Select issue type...</option>
                <option value="Blockage">Blockage</option>
                <option value="Structural Damage">Structural Damage</option>
                <option value="Flooding">Flooding</option>
                <option value="Debris Accumulation">Debris Accumulation</option>
                <option value="Equipment Failure">Equipment Failure</option>
                <option value="Safety Hazard">Safety Hazard</option>
                <option value="Other">Other</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="issue-priority" class="form-label">Priority *</label>
              <select class="form-select" id="issue-priority" required>
                <option value="Low">Low</option>
                <option value="Medium" selected>Medium</option>
                <option value="High">High</option>
                <option value="Critical">Critical</option>
              </select>
            </div>
            
            <div class="mb-3">
              <label for="issue-description" class="form-label">Description *</label>
              <textarea class="form-control" id="issue-description" rows="4" required
                        placeholder="Describe the issue in detail..."></textarea>
            </div>
            
            <div class="mb-3">
              <label for="issue-images" class="form-label">Upload Photos</label>
              <input type="file" class="form-control" id="issue-images" multiple accept="image/*">
              <div class="form-text">Upload photos of the issue (optional)</div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-warning" onclick="submitIssueReport()">
            <i class="fas fa-paper-plane me-1"></i>Submit Report
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Work Log Modal -->
  <div class="modal fade" id="workLogModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-success">
          <h5 class="modal-title text-white">
            <i class="fas fa-clipboard-list me-2"></i>Log Work Hours
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="workLogForm">
            <div class="mb-3">
              <label for="worklog-task-select" class="form-label">Select Task *</label>
              <select class="form-select" id="worklog-task-select" required>
                <option value="">Choose a task...</option>
              </select>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="work-date" class="form-label">Work Date *</label>
                  <input type="date" class="form-control" id="work-date" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="hours-worked" class="form-label">Hours Worked *</label>
                  <input type="number" class="form-control" id="hours-worked" step="0.5" min="0" max="24" required>
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="work-description" class="form-label">Work Description *</label>
              <textarea class="form-control" id="work-description" rows="3" required
                        placeholder="Describe the work performed..."></textarea>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="completion-percentage" class="form-label">Completion Percentage</label>
                  <input type="number" class="form-control" id="completion-percentage" min="0" max="100" 
                         placeholder="0-100%">
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="materials-used" class="form-label">Materials Used</label>
                  <input type="text" class="form-control" id="materials-used" 
                         placeholder="List materials used (optional)">
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" onclick="submitWorkLog()">
            <i class="fas fa-save me-1"></i>Log Work Hours
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle with Popper -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
  
  <script>
     // Global variables - Using same pattern as operator-map.html
     let currentUser = null;
    let operatorTasks = []; // Main array for user's tasks
    let operatorStats = {};
    let operatorNotifications = [];
    let drainagePoints = [];
    let refreshInterval;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      checkAuthentication();
    });

    /**
     * Check if user is authenticated and has appropriate role
     * Using same authentication pattern as operator-map.html
     */
    async function checkAuthentication() {
      try {
        const response = await fetch('../api/session-check.php');
        const result = await response.json();
        
        if (result.success && result.authenticated) {
          if (result.user.role !== 'Operator') {
            showNotification('Access denied. This dashboard is for operators only.', 'danger');
            setTimeout(() => {
              window.location.href = '../login.html?unauthorized=1';
            }, 2000);
            return;
          }
          
          currentUser = result.user;
          
          // Display user name
          let displayName = currentUser.name;
          if (!displayName) {
            const firstName = currentUser.first_name || '';
            const lastName = currentUser.last_name || '';
            displayName = (firstName + ' ' + lastName).trim() || 'Operator';
          }
          
          const userNameElement = document.getElementById('userName');
          if (userNameElement) {
            userNameElement.textContent = displayName;
          }
          
          hideLoadingOverlay();
          initializeDashboard();
        } else {
          window.location.href = '../login.html?unauthorized=1';
        }
      } catch (error) {
        console.error('Authentication check failed:', error);
        showNotification('Authentication check failed. Redirecting to login...', 'danger');
        setTimeout(() => {
          window.location.href = '../login.html?error=1';
        }, 2000);
      }
    }

    /**
     * Initialize dashboard - Using same pattern as operator-map.html
     */
    async function initializeDashboard() {
      try {
        await loadOperatorData();
        setupAutoRefresh();
        console.log(`Dashboard initialized for operator ${currentUser.id} with ${operatorTasks.length} tasks`);
        showNotification('Dashboard loaded successfully', 'success');
      } catch (error) {
        console.error('Dashboard initialization failed:', error);
        showNotification('Dashboard loaded with limited functionality', 'warning');
        // Don't fail completely - try to load fallback data
        try {
          loadFallbackData();
        } catch (fallbackError) {
          console.error('Fallback data loading failed:', fallbackError);
        }
      }
    }

    /**
     * Load operator-specific data - Same as operator-map.html
     */
    async function loadOperatorData() {
      try {
        await Promise.all([
          loadOperatorTasks(),
          loadOperatorStats(),
          loadOperatorNotifications(),
          loadDrainagePoints()
        ]);

        // Only update display if elements exist
        try {
          updateDashboardDisplay();
          displayOperatorTasks();
          displayOperatorNotifications();
          displayRecentActivities();
          populateTaskSelects();
          initializeCharts();
        } catch (displayError) {
          console.warn('Some dashboard elements not available:', displayError.message);
          // This is expected for map pages vs dashboard pages
        }
        
        console.log(`Loaded ${operatorTasks.length} tasks for operator ${currentUser.id}`);

      } catch (error) {
        console.error('Error loading operator data:', error);
        loadFallbackData();
      }
    }

    /**
     * Load tasks assigned to the current operator - Same logic as operator-map.html
     */
    async function loadOperatorTasks() {
      try {
        const response = await fetch(`operator-tasks.php?operator_id=${currentUser.id}`);
        if (!response.ok) throw new Error('Failed to fetch tasks');
        
        const result = await response.json();
        operatorTasks = result.success ? (result.tasks || []) : [];
        
        // Sort tasks by nearest due date
        operatorTasks = sortTasksByDueDate(operatorTasks);
        
        console.log('Loaded operator tasks:', operatorTasks.length);
      } catch (error) {
        console.error('Error loading operator tasks:', error);
        operatorTasks = [];
      }
    }

    /**
     * Sort tasks by nearest due date (pending/in-progress first, then by date)
     */
    function sortTasksByDueDate(tasks) {
      return tasks.sort((a, b) => {
        // First, prioritize non-completed tasks
        const aCompleted = a.status === 'Completed';
        const bCompleted = b.status === 'Completed';
        
        if (aCompleted && !bCompleted) return 1;
        if (!aCompleted && bCompleted) return -1;
        
        // Then sort by due date
        const aDate = new Date(a.scheduled_date || a.due_date || '9999-12-31');
        const bDate = new Date(b.scheduled_date || b.due_date || '9999-12-31');
        
        // For overdue tasks, show them first
        const today = new Date();
        const aOverdue = aDate < today && !aCompleted;
        const bOverdue = bDate < today && !bCompleted;
        
        if (aOverdue && !bOverdue) return -1;
        if (!aOverdue && bOverdue) return 1;
        
        // Finally sort by date
        return aDate - bDate;
      });
    }

    /**
     * Get active (non-completed) tasks
     */
    function getActiveTasks() {
      return operatorTasks.filter(task => task.status !== 'Completed');
    }

    /**
     * Get completed tasks
     */
    function getCompletedTasks() {
      return operatorTasks.filter(task => task.status === 'Completed');
    }

    /**
     * Load operator statistics - Same as operator-map.html
     */
    async function loadOperatorStats() {
      try {
        const response = await fetch(`operator-stats.php?operator_id=${currentUser.id}`);
        if (!response.ok) throw new Error('Failed to fetch stats');
        
        operatorStats = await response.json();
        console.log('Loaded operator stats:', operatorStats);
      } catch (error) {
        console.error('Error loading operator stats:', error);
        operatorStats = generateFallbackStats();
      }
    }

    /**
     * Load operator notifications - Same as operator-map.html
     */
     async function loadOperatorNotifications() {
  try {
    console.log('Loading notifications for operator:', currentUser.id);
    
    const response = await fetch(`operator-notifications.php?operator_id=${currentUser.id}`);
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    
    const data = await response.json();
    console.log('Raw notification response:', data);
    
    // Handle different response formats
    if (data.success && Array.isArray(data.notifications)) {
      operatorNotifications = data.notifications;
    } else if (data.success && Array.isArray(data.data)) {
      operatorNotifications = data.data;
    } else if (Array.isArray(data)) {
      operatorNotifications = data;
    } else {
      console.warn('Unexpected notification data format:', data);
      operatorNotifications = [];
    }
    
    console.log('Processed notifications:', operatorNotifications);
    
    // Generate sample notifications if none exist (for testing)
    if (operatorNotifications.length === 0) {
      operatorNotifications = generateSampleNotifications();
      console.log('Generated sample notifications:', operatorNotifications);
    }
    
  } catch (error) {
    console.error('Error loading notifications:', error);
    // Generate sample notifications for testing
    operatorNotifications = generateSampleNotifications();
  }
}
    /**
     * Load drainage points
     */
    async function loadDrainagePoints() {
      try {
        const response = await fetch('../api/drainage-points.php');
        const result = await response.json();
        
        if (Array.isArray(result)) {
          drainagePoints = result;
        } else if (result.success && Array.isArray(result.data)) {
          drainagePoints = result.data;
        } else {
          drainagePoints = getSampleDrainagePoints();
        }
      } catch (error) {
        console.error('Error loading drainage points:', error);
        drainagePoints = getSampleDrainagePoints();
      }
    }

    /**
     * Update dashboard display with operator data - Safe element handling
     */
    function updateDashboardDisplay() {
      // Get active tasks for statistics
      const activeTasks = getActiveTasks();
      
      // Update statistics - safely handle missing elements
      const statElements = {
        'stat-pending': activeTasks.filter(t => t.status === 'Pending' || t.status === 'Scheduled').length,
        'stat-progress': activeTasks.filter(t => t.status === 'In Progress').length,
        'stat-completed': operatorStats.completed_today || 0,
        'stat-overdue': activeTasks.filter(t => new Date(t.scheduled_date) < new Date()).length
      };

      Object.entries(statElements).forEach(([id, value]) => {
        const element = document.getElementById(id);
        if (element) {
          element.textContent = value;
        }
      });

      // Update main statistics
      updateStatistics();
      updateTodaySchedule();
      updatePerformanceMetrics();
      updateTaskCount();
    }

    /**
     * Update statistics based on operatorTasks
     */
    function updateStatistics() {
      const activeTasks = getActiveTasks();
      const completedTasks = getCompletedTasks();
      
      const totalActiveTasks = activeTasks.length;
      const pendingTasks = activeTasks.filter(t => t.status === 'Pending' || t.status === 'Scheduled').length;
      const inProgressTasks = activeTasks.filter(t => t.status === 'In Progress').length;
      const inspectionTasks = activeTasks.filter(t => t.task_category === 'Inspection').length;
      const totalCompletedTasks = completedTasks.length;
      const overdueTasks = activeTasks.filter(t => 
        new Date(t.scheduled_date) < new Date()
      ).length;

      animateCounter('total-tasks', totalActiveTasks);
      animateCounter('pending-tasks', pendingTasks);
      animateCounter('in-progress-tasks', inProgressTasks);
      animateCounter('inspection-tasks', inspectionTasks);
      animateCounter('completed-tasks', totalCompletedTasks);
      animateCounter('overdue-tasks', overdueTasks);
    }

    /**
     * Update today's schedule
     */
    function updateTodaySchedule() {
      const container = document.getElementById('today-schedule-list');
      if (!container) return;
      
      const today = new Date().toISOString().split('T')[0];
      const activeTasks = getActiveTasks();
      const todayTasks = activeTasks.filter(task => task.scheduled_date === today);
      
      if (todayTasks.length === 0) {
        container.innerHTML = `
          <div class="text-center text-muted py-4">
            <i class="fas fa-calendar-check fa-3x mb-3"></i>
            <p>No active tasks assigned to me for today</p>
          </div>
        `;
        return;
      }

      container.innerHTML = todayTasks.map(task => `
        <div class="schedule-item">
          <div>
            <div class="schedule-time">${task.scheduled_time || '09:00'}</div>
            <div><strong>${task.drainage_point_name || 'Unknown Location'}</strong></div>
            <small>${task.task_type || task.request_type || 'Task'} (${task.task_category || 'Task'})</small>
          </div>
          <div>
            <span class="inspection-status ${task.status.toLowerCase().replace(' ', '-')}">
              ${task.status}
            </span>
          </div>
        </div>
      `).join('');
    }

    /**
     * Update performance metrics
     */
    function updatePerformanceMetrics() {
      const completionRate = operatorStats.completion_rate || 0;
      
      // Safely update elements
      const monthCompleted = document.getElementById('month-completed');
      const monthEfficiency = document.getElementById('month-efficiency');
      const efficiencyBar = document.getElementById('efficiency-bar');
      
      if (monthCompleted) {
        monthCompleted.textContent = operatorStats.total_completed || 0;
      }
      
      if (monthEfficiency) {
        monthEfficiency.textContent = Math.round(completionRate) + '%';
      }
      
      if (efficiencyBar) {
        const percentage = Math.round(completionRate);
        efficiencyBar.style.width = percentage + '%';
        efficiencyBar.textContent = percentage + '%';
      }
    }

    /**
     * Update task count display
     */
    function updateTaskCount() {
      const taskCountElement = document.getElementById('user-task-count');
      if (taskCountElement) {
        taskCountElement.textContent = getActiveTasks().length;
      }
    }

    /**
     * Display operator tasks in sidebar - Updated to separate active and completed tasks
     */
    function displayOperatorTasks() {
      const activeTasks = getActiveTasks();
      const completedTasks = getCompletedTasks();
      
      const activeMaintenanceTasks = activeTasks.filter(t => t.task_category === 'Maintenance');
      const activeInspectionTasks = activeTasks.filter(t => t.task_category === 'Inspection');
      const todayActiveTasks = activeTasks.filter(t => {
        const today = new Date().toISOString().split('T')[0];
        return t.scheduled_date === today;
      });

      // Display active tasks in main sections
      const allTasksList = document.getElementById('all-tasks-list');
      const maintenanceTasksList = document.getElementById('maintenance-tasks-list');
      const inspectionTasksList = document.getElementById('inspection-tasks-list');
      const todayTasksList = document.getElementById('today-tasks-list');
      const completedTasksList = document.getElementById('completed-tasks-list');

      if (allTasksList) {
        allTasksList.innerHTML = renderTasksList(activeTasks, 'No active tasks assigned to me');
      }
      if (maintenanceTasksList) {
        maintenanceTasksList.innerHTML = renderTasksList(activeMaintenanceTasks, 'No active maintenance tasks assigned to me');
      }
      if (inspectionTasksList) {
        inspectionTasksList.innerHTML = renderTasksList(activeInspectionTasks, 'No active inspection tasks assigned to me');
      }
      if (todayTasksList) {
        todayTasksList.innerHTML = renderTasksList(todayActiveTasks, 'No active tasks assigned to me for today');
      }
      
      // Display completed tasks in separate section
      if (completedTasksList) {
        completedTasksList.innerHTML = renderTasksList(completedTasks, 'No completed tasks yet', true);
      }
    }

    /**
     * Render tasks list - Updated to handle completed tasks styling
     */
    function renderTasksList(tasks, emptyMessage = 'No tasks found', isCompleted = false) {
      if (!tasks || tasks.length === 0) {
        return `<p class="text-muted text-center py-4">${emptyMessage}</p>`;
      }

      return tasks.map(task => createOperatorTaskCard(task, isCompleted)).join('');
    }

    /**
     * Create task card for operator interface - Updated with completed task styling
     */
    function createOperatorTaskCard(task, isCompleted = false) {
      const isOverdue = new Date(task.scheduled_date) < new Date() && task.status !== 'Completed';
      const priorityClass = `priority-${(task.priority || 'medium').toLowerCase()}`;
      const categoryClass = `${(task.task_category || task.request_type || 'maintenance').toLowerCase()}-task`;
      const completedClass = isCompleted ? 'completed-task' : '';
      
      return `
        <div class="task-card ${priorityClass} ${categoryClass} ${completedClass} assigned-to-me" onclick="focusOnTask('${task.id}', '${task.task_category || task.request_type}')">
          <div class="task-header">
            <h6 class="task-title ${isCompleted ? 'text-muted' : ''}">${task.drainage_point_name || task.point_name || 'Unknown Location'}</h6>
            ${isCompleted ? '<i class="fas fa-check-circle text-success ms-2"></i>' : ''}
          </div>
          
          <div class="task-location ${isCompleted ? 'text-muted' : ''}">${task.task_type || task.request_type || 'Task'}</div>
          
          <div class="task-badges">
            <span class="task-badge badge-${(task.task_category || task.request_type || 'maintenance').toLowerCase()}">${task.task_category || task.request_type || 'Maintenance'}</span>
            <span class="task-badge badge-priority-${(task.priority || 'medium').toLowerCase()}">${task.priority || 'Medium'}</span>
            <span class="task-badge badge-status-${(task.status || 'pending').toLowerCase().replace(' ', '-')}">${task.status || 'Pending'}</span>
            ${isOverdue && !isCompleted ? '<span class="task-badge badge-priority-critical">OVERDUE</span>' : ''}
            <span class="task-badge bg-info text-white">MY TASK</span>
            ${isCompleted ? `<span class="task-badge bg-success text-white">COMPLETED ${task.completion_date ? formatDate(task.completion_date) : ''}</span>` : ''}
          </div>
          
          <div class="task-meta ${isCompleted ? 'text-muted' : ''}">
            <span><i class="fas fa-calendar me-1"></i>${task.scheduled_date}</span>
            ${task.scheduled_time ? `<span><i class="fas fa-clock me-1"></i>${task.scheduled_time}</span>` : ''}
            ${isCompleted && task.completion_date ? `<span><i class="fas fa-check me-1"></i>Completed: ${formatDate(task.completion_date)}</span>` : ''}
          </div>
          
          <div class="task-actions">
            ${!isCompleted ? `
              <button class="task-action-btn btn-task-update" onclick="event.stopPropagation(); updateSpecificTask('${task.id}', '${task.task_category || task.request_type}')">
                <i class="fas fa-edit"></i>
                Update
              </button>
            ` : ''}
            <button class="task-action-btn btn-task-details" onclick="event.stopPropagation(); viewTaskDetails('${task.id}', '${task.task_category || task.request_type}')">
              <i class="fas fa-eye"></i>
              Details
            </button>
          </div>
        </div>
      `;
    }

    /**
     * Format date helper
     */
    function formatDate(dateString) {
      if (!dateString) return '';
      try {
        return new Date(dateString).toLocaleDateString();
      } catch (error) {
        return dateString;
      }
    }

    /**
     * Display recent activities - Updated to show more relevant active task activities
     */
    function displayRecentActivities() {
      const container = document.getElementById('recent-activities-list');
      if (!container) return;
      
      // Create recent activities from operator tasks
      const recentActivities = [];
      
      // Add recently updated active tasks
      getActiveTasks()
        .filter(task => task.updated_at)
        .sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at))
        .slice(0, 5)
        .forEach(task => {
          recentActivities.push({
            icon: task.task_category === 'Inspection' ? 'clipboard-check' : 'tools',
            color: task.task_category === 'Inspection' ? 'warning' : 'primary',
            title: `${task.task_category || 'Task'} Updated`,
            description: `${task.task_type || task.request_type} at ${task.drainage_point_name}`,
            time: formatTimeAgo(task.updated_at),
            status: task.status
          });
        });
      
      // Add recently completed tasks
      getCompletedTasks()
        .filter(task => task.completion_date)
        .sort((a, b) => new Date(b.completion_date) - new Date(a.completion_date))
        .slice(0, 3)
        .forEach(task => {
          recentActivities.push({
            icon: 'check-circle',
            color: 'success',
            title: `${task.task_category || 'Task'} Completed`,
            description: `${task.task_type || task.request_type} at ${task.drainage_point_name}`,
            time: formatTimeAgo(task.completion_date),
            status: 'Completed'
          });
        });

      // Sort all activities by time and take top 8
      recentActivities.sort((a, b) => {
        // This is a simple sort - in a real app you'd parse the timestamps properly
        return b.time.localeCompare(a.time);
      });

      const topActivities = recentActivities.slice(0, 8);

      if (topActivities.length === 0) {
        container.innerHTML = `
          <div class="text-center text-muted py-4">
            <i class="fas fa-history fa-2x mb-2"></i>
            <p class="mb-0">No recent activities</p>
          </div>
        `;
        return;
      }

      container.innerHTML = topActivities.map(activity => `
        <div class="d-flex align-items-center mb-3 pb-3 border-bottom">
          <div class="flex-shrink-0">
            <div class="rounded-circle bg-${activity.color} bg-opacity-10 p-2">
              <i class="fas fa-${activity.icon} text-${activity.color}"></i>
            </div>
          </div>
          <div class="flex-grow-1 ms-3">
            <h6 class="mb-1">${activity.title}</h6>
            <p class="text-muted mb-1 small">${activity.description}</p>
            <div class="d-flex justify-content-between align-items-center">
              <small class="text-muted">${activity.time}</small>
              <span class="badge bg-${activity.color} bg-opacity-20 text-${activity.color}">${activity.status}</span>
            </div>
          </div>
        </div>
      `).join('');
    }

    /**
     * Format time ago helper
     */
    function formatTimeAgo(dateString) {
      if (!dateString) return 'Unknown';
      
      try {
        const date = new Date(dateString);
        const now = new Date();
        const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
        
        if (diffInHours < 1) return 'Just now';
        if (diffInHours < 24) return `${diffInHours}h ago`;
        
        const diffInDays = Math.floor(diffInHours / 24);
        if (diffInDays < 7) return `${diffInDays}d ago`;
        
        return date.toLocaleDateString();
      } catch (error) {
        return 'Recently';
      }
    }

    function displayOperatorNotifications() {
  const container = document.getElementById('notifications-list');
  
  if (!container) {
    console.warn('Notifications container not found');
    return;
  }
  
  // Debug: Log the actual notifications data
  console.log('Displaying notifications:', operatorNotifications);
  console.log('Notifications count:', operatorNotifications ? operatorNotifications.length : 0);
  
  if (!operatorNotifications || operatorNotifications.length === 0) {
    container.innerHTML = '<p class="text-muted small">No new notifications.</p>';
    updateBadge(0);
    return;
  }

  const notifications = operatorNotifications.slice(0, 5);
  container.innerHTML = notifications.map(notification => `
    <div class="notification-item">
      <i class="notification-icon fas fa-${getNotificationIcon(notification.type)}"></i>
      <div class="notification-content">
        <h6>${notification.title}</h6>
        <p>${notification.message}</p>
        <small class="text-muted">${formatTimeAgo(notification.created_at || notification.timestamp)}</small>
      </div>
    </div>
  `).join('');
  
  // Update badge with notification count
  updateBadge(operatorNotifications.length);
}

function updateBadge(count) {
  // Try multiple possible badge element IDs
  const possibleBadgeIds = ['unread-count', 'notification-badge', 'notifications-count', 'badge-notifications'];
  let badge = null;
  
  for (const id of possibleBadgeIds) {
    badge = document.getElementById(id);
    if (badge) break;
  }
  
  if (!badge) {
    console.warn('Notification badge element not found. Tried IDs:', possibleBadgeIds);
    return;
  }
  
  console.log('Updating badge count to:', count);
  badge.textContent = count;
  
  // Hide badge if no notifications, show if there are notifications
  if (count === 0) {
    badge.style.display = 'none';
    badge.classList.remove('badge-danger', 'badge-warning');
  } else {
    badge.style.display = 'inline-block';
    // Add visual styling based on count
    if (count > 5) {
      badge.classList.add('badge-danger');
      badge.classList.remove('badge-warning');
    } else if (count > 0) {
      badge.classList.add('badge-warning');
      badge.classList.remove('badge-danger');
    }
  }
}
function createTaskNotification(task) {
  const notification = {
    id: `new-task-${task.id}`,
    title: 'New Task Assigned',
    message: `You have been assigned: ${task.task_type} at ${task.drainage_point_name}`,
    type: 'info',
    created_at: new Date().toISOString(),
    read: false
  };
  
  // Add to notifications array
  operatorNotifications.unshift(notification);
  
  // Update display
  displayOperatorNotifications();
  
  // Show toast notification
  showNotification(`New task assigned: ${task.task_type}`, 'info');
}
    /**
     * Populate task selection dropdowns - Updated to exclude completed tasks
     */
    function populateTaskSelects() {
      const taskSelect = document.getElementById('task-select');
      const worklogTaskSelect = document.getElementById('worklog-task');
      const activeTasks = getActiveTasks();

      if (taskSelect) {
        taskSelect.innerHTML = '<option value="">Choose one of my active tasks...</option>';
        activeTasks.forEach(task => {
          const option = document.createElement('option');
          option.value = task.id;
          option.textContent = `${task.drainage_point_name || task.point_name} - ${task.task_type || task.request_type}`;
          option.setAttribute('data-task-type', task.task_category || task.request_type);
          taskSelect.appendChild(option);
        });
      }

      if (worklogTaskSelect) {
        worklogTaskSelect.innerHTML = '<option value="">Choose one of my active tasks...</option>';
        activeTasks.forEach(task => {
          const option = document.createElement('option');
          option.value = task.id;
          option.textContent = `${task.drainage_point_name || task.point_name} - ${task.task_type || task.request_type}`;
          worklogTaskSelect.appendChild(option);
        });
      }

      // Add event listener for task selection
      if (taskSelect) {
        taskSelect.addEventListener('change', function() {
          const selectedTaskId = this.value;
          const selectedTask = activeTasks.find(t => t.id == selectedTaskId);
          
          if (selectedTask) {
            const taskInfo = document.getElementById('task-type-display');
            const taskInfoContent = document.getElementById('task-type-info');
            
            if (taskInfo && taskInfoContent) {
              taskInfoContent.innerHTML = `
                <strong>Task:</strong> ${selectedTask.task_type || selectedTask.request_type}<br>
                <strong>Location:</strong> ${selectedTask.drainage_point_name || selectedTask.point_name}<br>
                <strong>Priority:</strong> ${selectedTask.priority}<br>
                <strong>Scheduled:</strong> ${selectedTask.scheduled_date}<br>
                <span class="badge bg-info">ASSIGNED TO ME</span>
              `;
              taskInfo.style.display = 'block';
            }

            // Show inspection fields if it's an inspection task
            const inspectionFields = document.getElementById('inspection-fields');
            const inspectionRecommendations = document.getElementById('inspection-recommendations');
            const inspectionConditionFields = document.getElementById('inspection-condition-fields');
            const maintenanceRequestOption = document.getElementById('maintenance-request-option');
            
            if (inspectionFields && inspectionRecommendations && inspectionConditionFields && maintenanceRequestOption) {
              const isInspection = (selectedTask.task_category || selectedTask.request_type || '').toLowerCase().includes('inspection');
              inspectionFields.style.display = isInspection ? 'block' : 'none';
              inspectionRecommendations.style.display = isInspection ? 'block' : 'none';
              inspectionConditionFields.style.display = isInspection ? 'block' : 'none';
              maintenanceRequestOption.style.display = isInspection ? 'block' : 'none';
            }
          }
        });
      }
    }

    /**
     * Initialize charts - safely handle missing elements
     */
    function initializeCharts() {
      const ctx = document.getElementById('workProgressChart');
      if (!ctx) {
        console.info('Chart canvas not found - skipping chart initialization');
        return;
      }
      
      // Sample data for chart based on active vs completed tasks
      const activeTasks = getActiveTasks();
      const completedTasks = getCompletedTasks();
      
      const chartData = {
        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
        datasets: [
          {
            label: 'My Maintenance',
            data: [2, 3, 1, 4],
            borderColor: '#28a745',
            backgroundColor: 'rgba(40, 167, 69, 0.1)',
            tension: 0.4
          },
          {
            label: 'My Inspections',
            data: [1, 2, 2, 3],
            borderColor: '#ffc107',
            backgroundColor: 'rgba(255, 193, 7, 0.1)',
            tension: 0.4
          }
        ]
      };
      
      try {
        new Chart(ctx, {
          type: 'line',
          data: chartData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            }
          }
        });
        console.log('Chart initialized successfully');
      } catch (error) {
        console.warn('Chart initialization failed:', error.message);
      }
    }

    /**
     * Setup auto-refresh for operator data
     */
    function setupAutoRefresh() {
      refreshInterval = setInterval(() => {
        refreshOperatorData();
      }, 300000); // Refresh every 5 minutes
    }

    /**
     * Refresh operator data
     */
    async function refreshOperatorData() {
      try {
        console.log('Refreshing operator data...');
        await loadOperatorData();
        showNotification('Data refreshed successfully', 'success');
      } catch (error) {
        console.error('Error refreshing data:', error);
        showNotification('Error refreshing data', 'warning');
      }
    }

    /**
     * Generate fallback stats when API fails
     */
    function generateFallbackStats() {
      return {
        pending: Math.floor(Math.random() * 5) + 1,
        in_progress: Math.floor(Math.random() * 3) + 1,
        completed_today: Math.floor(Math.random() * 3),
        overdue: Math.floor(Math.random() * 2),
        completion_rate: Math.floor(Math.random() * 30) + 70,
        completed_this_week: Math.floor(Math.random() * 10) + 5
      };
    }

    /**
     * Load fallback data when APIs fail
     */
    function loadFallbackData() {
      operatorStats = generateFallbackStats();
      operatorTasks = [
        {
          id: 1,
          drainage_point_name: 'PO 03 - Parit Othman',
          task_type: 'Cleaning',
          task_category: 'Maintenance',
          priority: 'High',
          status: 'Pending',
          scheduled_date: new Date().toISOString().split('T')[0],
          updated_at: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString() // 2 hours ago
        },
        {
          id: 2,
          drainage_point_name: 'BB7 - Sg Bentayan',
          task_type: 'Routine Inspection',
          task_category: 'Inspection',
          priority: 'Medium',
          status: 'Scheduled',
          scheduled_date: new Date().toISOString().split('T')[0],
          scheduled_time: '09:00',
          updated_at: new Date(Date.now() - 5 * 60 * 60 * 1000).toISOString() // 5 hours ago
        },
        {
          id: 3,
          drainage_point_name: 'HP2 - Hospital Drain',
          task_type: 'Emergency Repair',
          task_category: 'Maintenance',
          priority: 'Critical',
          status: 'Completed',
          scheduled_date: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString().split('T')[0], // Yesterday
          completion_date: new Date(Date.now() - 3 * 60 * 60 * 1000).toISOString(), // 3 hours ago
          updated_at: new Date(Date.now() - 3 * 60 * 60 * 1000).toISOString()
        }
      ];
      operatorNotifications = [
        {
          title: 'High Priority Task Due',
          message: 'Drainage cleaning at PO03 is scheduled for today',
          type: 'warning'
        }
      ];

      // Only update display if elements exist
      try {
        updateDashboardDisplay();
        displayOperatorTasks();
        displayOperatorNotifications();
        displayRecentActivities();
        populateTaskSelects();
      } catch (error) {
        console.warn('Some dashboard elements not available:', error.message);
        // Continue without failing - this is expected for different page layouts
      }
    }

    /**
     * Modal handlers with full functionality
     */
    function showUpdateTaskModal() {
      const modal = new bootstrap.Modal(document.getElementById('updateTaskModal'));
      modal.show();
    }

    function showReportIssueModal() {
      const modal = new bootstrap.Modal(document.getElementById('reportIssueModal'));
      modal.show();
      
      // Set current date
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('work-date').value = today;
    }

    function showWorkLogModal() {
      const modal = new bootstrap.Modal(document.getElementById('workLogModal'));
      modal.show();
      
      // Populate work log task dropdown
      const worklogTaskSelect = document.getElementById('worklog-task-select');
      if (worklogTaskSelect && operatorTasks.length > 0) {
        worklogTaskSelect.innerHTML = '<option value="">Choose a task...</option>';
        operatorTasks.forEach(task => {
          if (task.status !== 'Completed') {
            const option = document.createElement('option');
            option.value = task.id;
            option.textContent = `${task.drainage_point_name || task.point_name} - ${task.task_type || task.request_type}`;
            option.setAttribute('data-task-category', task.task_category || task.request_type);
            worklogTaskSelect.appendChild(option);
          }
        });
      }
      
      // Set current date
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('work-date').value = today;
    }

    /**
     * Submit issue report with full functionality
     */
    async function submitIssueReport() {
      const location = document.getElementById('issue-location').value.trim();
      const issueType = document.getElementById('issue-type').value;
      const priority = document.getElementById('issue-priority').value;
      const description = document.getElementById('issue-description').value.trim();

      // Validation
      if (!location || !issueType || !description) {
        showNotification('Please fill in all required fields', 'warning');
        return;
      }

      const issueData = {
        action: 'report_issue',
        location: location,
        issue_type: issueType,
        priority: priority,
        description: description
      };

      try {
        const response = await fetch('operator-tasks.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(issueData),
        });

        const result = await response.json();

        if (result.success) {
          showNotification('Issue report submitted successfully!', 'success');
          bootstrap.Modal.getInstance(document.getElementById('reportIssueModal')).hide();
          document.getElementById('reportIssueForm').reset();
          
          // Refresh data to show new activity
          await loadOperatorData();
        } else {
          throw new Error(result.message || 'Failed to submit issue report');
        }
      } catch (error) {
        console.error('Error submitting issue report:', error);
        showNotification(`Error submitting issue report: ${error.message}`, 'danger');
      }
    }

    /**
     * Submit work log with full functionality
     */
    async function submitWorkLog() {
      const taskId = document.getElementById('worklog-task-select').value;
      const workDate = document.getElementById('work-date').value;
      const hoursWorked = document.getElementById('hours-worked').value;
      const workDescription = document.getElementById('work-description').value.trim();
      const completionPercentage = document.getElementById('completion-percentage').value;
      const materialsUsed = document.getElementById('materials-used').value.trim();

      // Validation
      if (!taskId || !workDate || !hoursWorked || !workDescription) {
        showNotification('Please fill in all required fields', 'warning');
        return;
      }

      // Get task category
      const selectedTask = operatorTasks.find(t => t.id == taskId);
      const taskCategory = selectedTask ? (selectedTask.task_category || selectedTask.request_type || 'Maintenance') : 'Maintenance';

      const workLogData = {
        action: 'log_work_hours',
        task_id: parseInt(taskId),
        work_date: workDate,
        hours_worked: parseFloat(hoursWorked),
        work_description: workDescription,
        completion_percentage: completionPercentage ? parseInt(completionPercentage) : 0,
        materials_used: materialsUsed,
        task_category: taskCategory
      };

      try {
        const response = await fetch('operator-tasks.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(workLogData),
        });

        const result = await response.json();

        if (result.success) {
          showNotification('Work hours logged successfully!', 'success');
          bootstrap.Modal.getInstance(document.getElementById('workLogModal')).hide();
          document.getElementById('workLogForm').reset();
          
          // Refresh data to show updated progress
          await loadOperatorData();
        } else {
          throw new Error(result.message || 'Failed to log work hours');
        }
      } catch (error) {
        console.error('Error logging work hours:', error);
        showNotification(`Error logging work hours: ${error.message}`, 'danger');
      }
    }

    /**
     * Task action functions
     */
    function updateSpecificTask(taskId, taskType) {
      const task = operatorTasks.find(t => t.id == taskId);
      if (task) {
        // Pre-select the task in the update modal
        showUpdateTaskModal();
        setTimeout(() => {
          const taskSelect = document.getElementById('task-select');
          if (taskSelect) {
            taskSelect.value = taskId;
            taskSelect.dispatchEvent(new Event('change'));
          }
        }, 100);
      }
    }

    function viewTaskDetails(taskId, taskType) {
      const task = operatorTasks.find(t => t.id == taskId);
      if (task) {
        showNotification(`Task Details: ${task.task_type || task.request_type} at ${task.drainage_point_name}`, 'info');
      }
    }

    function focusOnTask(taskId, taskType) {
      const task = operatorTasks.find(t => t.id == taskId);
      if (task) {
        showNotification(`Focused on task: ${task.task_type || task.request_type}`, 'info');
      }
    }

    async function updateTaskStatus() {
      const taskId = document.getElementById('task-select').value;
      const newStatus = document.getElementById('task-status').value;
      const notes = document.getElementById('task-notes').value.trim();

      if (!taskId || !newStatus) {
        showNotification('Please select a task and new status', 'warning');
        return;
      }

      const updateData = {
        task_id: taskId,
        status: newStatus,
        notes: notes,
        updated_by: currentUser.id
      };

      try {
        const response = await fetch('operator-tasks.php', {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(updateData),
        });

        const result = await response.json();

        if (result.success) {
          showNotification('My task status updated successfully', 'success');
          bootstrap.Modal.getInstance(document.getElementById('updateTaskModal')).hide();
          document.getElementById('updateTaskForm').reset();
          const taskTypeDisplay = document.getElementById('task-type-display');
          if (taskTypeDisplay) {
            taskTypeDisplay.style.display = 'none';
          }
          
          // Reload data
          await loadOperatorData();
        } else {
          throw new Error(result.message || 'Failed to update task status');
        }
      } catch (error) {
        console.error('Error updating task status:', error);
        showNotification(`Error updating my task: ${error.message}`, 'danger');
      }
    }

    // Utility functions
    /**
     * Animate counter with safe element handling
     */
    function animateCounter(elementId, targetValue) {
      const element = document.getElementById(elementId);
      if (!element) {
        console.warn(`Element ${elementId} not found for counter animation`);
        return;
      }
      
      const startValue = 0;
      const duration = 1500;
      const startTime = performance.now();
      
      function updateCounter(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const currentValue = Math.floor(startValue + (targetValue - startValue) * progress);
        
        element.textContent = currentValue;
        
        if (progress < 1) {
          requestAnimationFrame(updateCounter);
        }
      }
      
      requestAnimationFrame(updateCounter);
    }

    function getNotificationIcon(type) {
      const icons = {
        success: "check-circle",
        danger: "exclamation-triangle",
        warning: "exclamation-triangle",
        info: "info-circle",
      };
      return icons[type] || "info-circle";
    }

    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.className = `alert alert-${type} alert-dismissible fade show notification`;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        max-width: 500px;
      `;
      notification.innerHTML = `
        <i class="fas fa-${getNotificationIcon(type)} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(notification);
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 5000);
    }

    function getSampleDrainagePoints() {
      return [
        { id: 1, name: 'PO 03 - Parit Othman', type: 'Concrete Drain' },
        { id: 2, name: 'BB7 - Sg Bentayan', type: 'Natural Drain' },
        { id: 3, name: 'HP2 - Hospital', type: 'Covered Drain' }
      ];
    }

    /**
     * Hide loading overlay
     */
    function hideLoadingOverlay() {
      const overlay = document.getElementById('loadingOverlay');
      if (overlay) {
        overlay.style.opacity = '0';
        setTimeout(() => {
          overlay.style.display = 'none';
        }, 300);
      }
    }

    /**
     * Logout function
     */
    async function logout() {
      try {
        showNotification('Logging out...', 'info');
        
        if (refreshInterval) {
          clearInterval(refreshInterval);
        }
        
        await fetch('../api/logout.php', { method: 'POST' });
        window.location.href = '../login.html?logout=1';
      } catch (error) {
        console.error('Logout failed:', error);
        window.location.href = '../login.html?logout=1';
      }
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (refreshInterval) {
        clearInterval(refreshInterval);
      }
    });
  </script>
</body>
</html>