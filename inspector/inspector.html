<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DrainTrack - Inspector Dashboard</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <!-- Chart.js for data visualization -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <!-- Common DrainTrack Styles -->
  <link href="../css/common.css" rel="stylesheet">
  
  <style>
    /* Inspector-specific styles */
    .inspector-card {
      border-left: 4px solid var(--primary-color);
      transition: all 0.3s ease;
    }

    .inspector-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .priority-critical {
      border-left-color: var(--danger-color) !important;
    }

    .priority-high {
      border-left-color: var(--warning-color) !important;
    }

    .priority-medium {
      border-left-color: var(--accent-color) !important;
    }

    .priority-low {
      border-left-color: var(--success-color) !important;
    }

    .inspection-status {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-weight: 600;
    }

    .status-scheduled {
      background-color: #e3f2fd;
      color: #1976d2;
    }

    .status-in-progress {
      background-color: #fff3e0;
      color: #f57c00;
    }

    .status-completed {
      background-color: #e8f5e8;
      color: #2e7d32;
    }

    .status-overdue {
      background-color: #ffebee;
      color: #c62828;
    }

    .quick-action-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .quick-action-card {
      background: var(--gradient-primary);
      color: white;
      border-radius: 15px;
      padding: 1.5rem;
      text-decoration: none;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .quick-action-card:hover {
      color: white;
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(13, 110, 253, 0.3);
    }

    .quick-action-icon {
      font-size: 2.5rem;
      opacity: 0.9;
    }

    .quick-action-content h5 {
      margin: 0;
      font-weight: 600;
    }

    .quick-action-content p {
      margin: 0;
      opacity: 0.9;
    }

    .today-schedule {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }

    .schedule-item {
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .schedule-time {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .weather-widget {
      background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
      color: white;
      border-radius: 15px;
      padding: 1.5rem;
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .recent-activity {
      max-height: 400px;
      overflow-y: auto;
    }

    .activity-item {
      padding: 1rem;
      border-bottom: 1px solid #f0f0f0;
      transition: background-color 0.3s ease;
    }

    .activity-item:hover {
      background-color: #f8f9fa;
    }

    .activity-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      margin-right: 1rem;
    }

    .activity-completed {
      background-color: var(--success-color);
    }

    .activity-pending {
      background-color: var(--warning-color);
    }

    .activity-issue {
      background-color: var(--danger-color);
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .loading-content {
      text-align: center;
      color: var(--primary-color);
    }

    .loading-spinner {
      width: 3rem;
      height: 3rem;
      margin-bottom: 1rem;
    }

    /* Username styling in navbar */
    .user-info {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: white;
      padding: 0.375rem 0.75rem;
      border-radius: 0.375rem;
      transition: background-color 0.15s ease-in-out;
    }

    .user-info:hover {
      background-color: rgba(255, 255, 255, 0.1);
      color: white;
      text-decoration: none;
    }

    .user-role-badge {
      background: rgba(13, 110, 253, 0.2);
      color: #0d6efd;
      padding: 0.125rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      border: 1px solid rgba(13, 110, 253, 0.3);
    }

    @media (max-width: 768px) {
      .quick-action-grid {
        grid-template-columns: 1fr;
      }
      
      .quick-action-card {
        padding: 1rem;
      }
      
      .quick-action-icon {
        font-size: 2rem;
      }

      .user-role-badge {
        display: none;
      }
    }

    .span{
      color: white;
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="spinner-border loading-spinner" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <h4>Loading Dashboard...</h4>
      <p>Please wait while we prepare your workspace</p>
    </div>
  </div>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="inspector.html">
        <i class="fas fa-water"></i>
        DrainTrack
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item">
            <a class="nav-link active" href="inspector.html">
              <i class="fas fa-tachometer-alt me-1"></i>Dashboard
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="inspector-map.html">
              <i class="fas fa-map me-1"></i>Map View
            </a>
          </li>
          
        </ul>
        <div class="ms-3">
          
          <div class="dropdown d-inline">
            <a class="btn btn-outline-light dropdown-toggle" href="#" role="button" id="userDropdown" data-bs-toggle="dropdown">
              <i class="fas fa-user-circle me-1"></i><span id="userName">Operator</span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item" href="#"><i class="fas fa-user me-2"></i>Profile</a></li>
              <li><a class="dropdown-item" href="#"><i class="fas fa-cog me-2"></i>Settings</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="main-content">
    <div class="container-fluid">
      <!-- Page Header -->
      <div class="row mb-4">
        <div class="col-12">
          <h1 class="h2 mb-3 text-gradient">
            <i class="fas fa-tachometer-alt me-2"></i>
            Inspector Dashboard
          </h1>
          <p class="text-muted">Welcome back! Here's your inspection overview for today.</p>
        </div>
      </div>

      <!-- Statistics Cards -->
      <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
          <div class="card stats-card position-relative animate-slide-in">
            <div class="stats-number" id="total-inspections">0</div>
            <div class="stats-label">Total Inspections</div>
            <i class="fas fa-clipboard-check stats-icon"></i>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="card stats-card warning position-relative animate-slide-in">
            <div class="stats-number" id="pending-inspections">0</div>
            <div class="stats-label">Pending Today</div>
            <i class="fas fa-clock stats-icon"></i>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="card stats-card info position-relative animate-slide-in">
            <div class="stats-number" id="in-progress-inspections">0</div>
            <div class="stats-label">In Progress</div>
            <i class="fas fa-play stats-icon"></i>
          </div>
        </div>
        <div class="col-xl-3 col-md-6">
          <div class="card stats-card success position-relative animate-slide-in">
            <div class="stats-number" id="completed-today">0</div>
            <div class="stats-label">Completed Today</div>
            <i class="fas fa-check-circle stats-icon"></i>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="quick-action-grid">
        <a href="inspector-map.html" class="quick-action-card">
          <div class="quick-action-icon">
            <i class="fas fa-map"></i>
          </div>
          <div class="quick-action-content">
            <h5>Map View</h5>
            <p>View drainage points on map</p>
          </div>
        </a>
        
        <a href="#" class="quick-action-card" onclick="showAddInspectionModal()">
          <div class="quick-action-icon">
            <i class="fas fa-plus-circle"></i>
          </div>
          <div class="quick-action-content">
            <h5>New Inspection</h5>
            <p>Schedule an inspection</p>
          </div>
        </a>
        
        <a href="#" class="quick-action-card" onclick="showTab('inspection-reports')">
          <div class="quick-action-icon">
            <i class="fas fa-file-alt"></i>
          </div>
          <div class="quick-action-content">
            <h5>Reports</h5>
            <p>View inspection reports</p>
          </div>
        </a>
        
        <a href="#" class="quick-action-card" onclick="showIssueReportModal()">
          <div class="quick-action-icon">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="quick-action-content">
            <h5>Report Issue</h5>
            <p>Submit maintenance issue</p>
          </div>
        </a>
      </div>

      <!-- Main Dashboard Content -->
      <div class="row">
        <!-- Left Column -->
        <div class="col-xl-8">
          <!-- Today's Schedule -->
          <div class="today-schedule">
            <h4 class="mb-3">
              <i class="fas fa-calendar-day me-2"></i>
              Today's Inspection Schedule
            </h4>
            <div id="today-schedule-list">
              <div class="text-center py-3">
                <div class="spinner-border" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Inspection Status Chart -->
          <div class="card dashboard-card animate-fade-in">
            <div class="card-header card-header-custom">
              <i class="fas fa-chart-pie"></i>
              Inspection Status Overview
            </div>
            <div class="card-body">
              <div class="chart-container" style="height: 300px;">
                <canvas id="statusChart"></canvas>
              </div>
            </div>
          </div>

          <!-- My Inspections Table -->
          <div class="card dashboard-card animate-fade-in">
            <div class="card-header card-header-custom">
              <i class="fas fa-list"></i>
              My Recent Inspections
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover" id="inspections-table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Location</th>
                      <th>Type</th>
                      <th>Priority</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="inspections-table-body">
                    <tr>
                      <td colspan="6" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column -->
        <div class="col-xl-4">
          <!-- Weather Widget -->
          <div class="weather-widget">
            <div class="d-flex align-items-center justify-content-between">
              <div>
                <div style="font-size: 2rem; font-weight: 700;">28Â°C</div>
                <div>Partly Cloudy</div>
                <small>Muar, Johor</small>
              </div>
              <div>
                <i class="fas fa-cloud-sun fa-3x"></i>
              </div>
            </div>
            <div class="mt-3">
              <small>Perfect weather for inspections!</small>
            </div>
          </div>

          <!-- Upcoming Inspections -->
          <div class="card dashboard-card animate-fade-in">
            <div class="card-header card-header-custom">
              <i class="fas fa-calendar-alt"></i>
              Upcoming This Week
            </div>
            <div class="card-body">
              <div id="upcoming-inspections">
                <div class="text-center py-3">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent Activity -->
          <div class="card dashboard-card animate-fade-in">
            <div class="card-header card-header-custom">
              <i class="fas fa-history"></i>
              Recent Activity
            </div>
            <div class="card-body p-0">
              <div class="recent-activity" id="recent-activity">
                <div class="text-center py-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Performance Summary -->
          <div class="card dashboard-card animate-fade-in">
            <div class="card-header card-header-custom">
              <i class="fas fa-chart-line"></i>
              This Month's Performance
            </div>
            <div class="card-body">
              <div class="row text-center">
                <div class="col-6">
                  <h4 class="text-primary" id="month-completed">0</h4>
                  <small class="text-muted">Completed</small>
                </div>
                <div class="col-6">
                  <h4 class="text-success" id="month-efficiency">0%</h4>
                  <small class="text-muted">On Time</small>
                </div>
              </div>
              <div class="progress mt-3">
                <div class="progress-bar" role="progressbar" style="width: 0%" id="efficiency-bar">0%</div>
              </div>
              <small class="text-muted">Overall Efficiency</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Start Inspection Modal -->
  <div class="modal fade" id="startInspectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary">
          <h5 class="modal-title">
            <i class="fas fa-play me-2"></i>Start Inspection
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="start-inspection-form">
            <input type="hidden" id="inspection-id" name="inspection_id">
            
            <div class="mb-3">
              <label class="form-label">Inspection Details</label>
              <div id="inspection-details" class="bg-light p-3 rounded">
                <!-- Populated dynamically -->
              </div>
            </div>
            
            <div class="mb-3">
              <label for="start-notes" class="form-label">Initial Notes</label>
              <textarea class="form-control" id="start-notes" rows="3" placeholder="Any initial observations or notes..."></textarea>
            </div>
            
            <div class="mb-3">
              <label for="start-images" class="form-label">Initial Photos</label>
              <input type="file" class="form-control" id="start-images" multiple accept="image/*">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" onclick="startInspection()">
            <i class="fas fa-play me-1"></i>Start Inspection
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Complete Inspection Modal -->
  <div class="modal fade" id="completeInspectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-success">
          <h5 class="modal-title">
            <i class="fas fa-check-circle me-2"></i>Complete Inspection
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="complete-inspection-form">
            <input type="hidden" id="complete-inspection-id" name="inspection_id">
            
            <div class="mb-3">
              <label for="findings" class="form-label">Findings *</label>
              <textarea class="form-control" id="findings" rows="4" required placeholder="Describe your inspection findings..."></textarea>
            </div>
            
            <div class="mb-3">
              <label for="recommendations" class="form-label">Recommendations</label>
              <textarea class="form-control" id="recommendations" rows="3" placeholder="Any recommendations for maintenance or follow-up..."></textarea>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="condition-rating" class="form-label">Overall Condition</label>
                  <select class="form-select" id="condition-rating">
                    <option value="Excellent">Excellent</option>
                    <option value="Good" selected>Good</option>
                    <option value="Fair">Fair</option>
                    <option value="Poor">Poor</option>
                    <option value="Critical">Critical</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="maintenance-required" class="form-label">Maintenance Required</label>
                  <select class="form-select" id="maintenance-required">
                    <option value="None">None Required</option>
                    <option value="Routine">Routine Maintenance</option>
                    <option value="Urgent">Urgent Repair</option>
                    <option value="Emergency">Emergency Action</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="completion-images" class="form-label">Final Photos</label>
              <input type="file" class="form-control" id="completion-images" multiple accept="image/*">
            </div>
            
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="create-maintenance-request">
              <label class="form-check-label" for="create-maintenance-request">
                Create maintenance request based on findings
              </label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" onclick="completeInspection()">
            <i class="fas fa-check me-1"></i>Complete Inspection
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Inspection Modal -->
  <div class="modal fade" id="addInspectionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-info">
          <h5 class="modal-title">
            <i class="fas fa-plus-circle me-2"></i>Schedule New Inspection
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="add-inspection-form">
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="drainage-point" class="form-label">Drainage Point *</label>
                  <select class="form-select" id="drainage-point" required>
                    <option value="">Select drainage point</option>
                    <!-- Will be populated -->
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="inspection-type" class="form-label">Inspection Type *</label>
                  <select class="form-select" id="inspection-type" required>
                    <option value="Routine Inspection">Routine Inspection</option>
                    <option value="Safety Inspection">Safety Inspection</option>
                    <option value="Structural Inspection">Structural Inspection</option>
                    <option value="Emergency Inspection">Emergency Inspection</option>
                    <option value="Post-Maintenance Inspection">Post-Maintenance Inspection</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="scheduled-date" class="form-label">Scheduled Date *</label>
                  <input type="date" class="form-control" id="scheduled-date" required>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="scheduled-time" class="form-label">Scheduled Time</label>
                  <input type="time" class="form-control" id="scheduled-time" value="09:00">
                </div>
              </div>
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="priority" class="form-label">Priority</label>
                  <select class="form-select" id="priority">
                    <option value="Low">Low</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="High">High</option>
                    <option value="Critical">Critical</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="frequency" class="form-label">Frequency</label>
                  <select class="form-select" id="frequency">
                    <option value="One-time" selected>One-time</option>
                    <option value="Weekly">Weekly</option>
                    <option value="Monthly">Monthly</option>
                    <option value="Quarterly">Quarterly</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="description" class="form-label">Description</label>
              <textarea class="form-control" id="description" rows="3" placeholder="Describe the purpose and scope of this inspection..."></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-info" onclick="scheduleInspection()">
            <i class="fas fa-calendar-plus me-1"></i>Schedule Inspection
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Issue Report Modal -->
  <div class="modal fade" id="issueReportModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-warning">
          <h5 class="modal-title">
            <i class="fas fa-exclamation-triangle me-2"></i>Report Issue
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="issue-report-form">
            <div class="mb-3">
              <label for="issue-location" class="form-label">Location *</label>
              <input type="text" class="form-control" id="issue-location" required placeholder="Describe the location">
            </div>
            
            <div class="row">
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="issue-type" class="form-label">Issue Type *</label>
                  <select class="form-select" id="issue-type" required>
                    <option value="">Select issue type</option>
                    <option value="Blockage">Blockage</option>
                    <option value="Structural Damage">Structural Damage</option>
                    <option value="Equipment Failure">Equipment Failure</option>
                    <option value="Safety Hazard">Safety Hazard</option>
                    <option value="Environmental">Environmental</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
              </div>
              <div class="col-md-6">
                <div class="mb-3">
                  <label for="issue-priority" class="form-label">Priority *</label>
                  <select class="form-select" id="issue-priority" required>
                    <option value="Low">Low</option>
                    <option value="Medium" selected>Medium</option>
                    <option value="High">High</option>
                    <option value="Critical">Critical</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div class="mb-3">
              <label for="issue-description" class="form-label">Description *</label>
              <textarea class="form-control" id="issue-description" rows="4" required placeholder="Describe the issue in detail..."></textarea>
            </div>
            
            <div class="mb-3">
              <label for="issue-images" class="form-label">Photos</label>
              <input type="file" class="form-control" id="issue-images" multiple accept="image/*">
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-warning" onclick="submitIssueReport()">
            <i class="fas fa-paper-plane me-1"></i>Submit Report
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap Bundle -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

  <script>
    // Global variables
    let inspections = [];
    let drainagePoints = [];
    let currentUser = null;

    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      checkAuthentication();
    });

    /**
     * Check if user is authenticated and has appropriate role
     */
    async function checkAuthentication() {
      try {
        const response = await fetch('../api/session-check.php');
        const result = await response.json();
        
        if (result.success && result.authenticated) {
          // Check if user has Inspector role
          if (result.user.role !== 'Inspector') {
            showNotification('Access denied. This dashboard is for inspectors only.', 'danger');
            setTimeout(() => {
              window.location.href = '../login.html?unauthorized=1';
            }, 2000);
            return;
          }
          
          currentUser = result.user;
          document.getElementById('userName').textContent = currentUser.name;
          hideLoadingOverlay();
          initializeDashboard();
        } else {
          // Redirect to login page
          window.location.href = '../login.html?unauthorized=1';
        }
      } catch (error) {
        console.error('Authentication check failed:', error);
        showNotification('Authentication check failed. Redirecting to login...', 'danger');
        setTimeout(() => {
          window.location.href = '../login.html?error=1';
        }, 2000);
      }
    }

    /**
     * Hide the loading overlay
     */
    function hideLoadingOverlay() {
      const overlay = document.getElementById('loadingOverlay');
      overlay.style.opacity = '0';
      setTimeout(() => {
        overlay.style.display = 'none';
      }, 300);
    }

    /**
     * Logout function - redirect to centralized login
     */
    async function logout() {
      try {
        showNotification('Logging out...', 'info');
        
        // Clear session on server
        await fetch('../api/logout.php', { method: 'POST' });
        
        // Redirect to login page
        window.location.href = '../login.html?logout=1';
      } catch (error) {
        console.error('Logout failed:', error);
        // Still redirect even if logout request fails
        window.location.href = '../login.html?logout=1';
      }
    }

    async function initializeDashboard() {
      try {
        await loadDashboardData();
        initializeCharts();
        
        // Update dashboard every 30 seconds
        setInterval(loadDashboardData, 30000);
      } catch (error) {
        console.error('Dashboard initialization failed:', error);
        showNotification('Failed to load dashboard data', 'warning');
      }
    }

    async function loadDashboardData() {
      try {
        // Load inspector dashboard data
        const response = await fetch('inspector-dashboard.php');
        const result = await response.json();
        
        if (result.success) {
          inspections = result.data.inspections || [];
          drainagePoints = result.data.drainage_points || [];
          
          updateStatistics(result.data.statistics);
          loadTodaySchedule(result.data.today_schedule);
          loadUpcomingInspections(result.data.upcoming_inspections);
          loadRecentActivity(result.data.recent_activity);
          renderInspectionsTable();
          populateDrainagePointsDropdown();
          updatePerformanceMetrics(result.data.performance);
        } else {
          throw new Error(result.message || 'Failed to load dashboard data');
        }
      } catch (error) {
        console.error('Error loading dashboard data:', error);
        showNotification('Error loading dashboard data, using sample data', 'warning');
        loadSampleData();
      }
    }

    function loadSampleData() {
      inspections = getSampleInspections();
      drainagePoints = getSampleDrainagePoints();
      
      updateStatistics({
        total_inspections: 15,
        pending_today: 3,
        in_progress: 1,
        completed_today: 2
      });
      
      loadTodaySchedule(inspections.filter(i => i.scheduled_date === new Date().toISOString().split('T')[0]));
      loadUpcomingInspections(inspections.slice(0, 3));
      loadRecentActivity(inspections.filter(i => i.status === 'Completed').slice(0, 5));
      renderInspectionsTable();
      populateDrainagePointsDropdown();
      updatePerformanceMetrics({ completed_this_month: 12, on_time_percentage: 85 });
    }

    function updateStatistics(stats) {
      animateCounter('total-inspections', stats.total_inspections || 0);
      animateCounter('pending-inspections', stats.pending_today || 0);
      animateCounter('in-progress-inspections', stats.in_progress || 0);
      animateCounter('completed-today', stats.completed_today || 0);
    }

    function updatePerformanceMetrics(performance) {
      document.getElementById('month-completed').textContent = performance.completed_this_month || 0;
      document.getElementById('month-efficiency').textContent = (performance.on_time_percentage || 0) + '%';
      
      const efficiencyBar = document.getElementById('efficiency-bar');
      const percentage = performance.on_time_percentage || 0;
      efficiencyBar.style.width = percentage + '%';
      efficiencyBar.textContent = percentage + '%';
    }

    function loadTodaySchedule(todayInspections) {
      const scheduleContainer = document.getElementById('today-schedule-list');
      
      if (!todayInspections || todayInspections.length === 0) {
        scheduleContainer.innerHTML = '<p class="text-center">No inspections scheduled for today</p>';
        return;
      }
      
      scheduleContainer.innerHTML = todayInspections.map(inspection => `
        <div class="schedule-item">
          <div>
            <div class="schedule-time">${inspection.scheduled_time || '09:00'}</div>
            <div>${inspection.drainage_point_name}</div>
            <small>${inspection.inspection_type}</small>
          </div>
          <div>
            <span class="inspection-status status-${inspection.status.toLowerCase().replace(' ', '-')}">
              ${inspection.status}
            </span>
            ${inspection.status === 'Scheduled' ? 
              `<button class="btn btn-sm btn-light ms-2" onclick="startInspectionModal(${inspection.id})">
                <i class="fas fa-play"></i> Start
              </button>` : 
              inspection.status === 'In Progress' ?
              `<button class="btn btn-sm btn-success ms-2" onclick="completeInspectionModal(${inspection.id})">
                <i class="fas fa-check"></i> Complete
              </button>` : ''
            }
          </div>
        </div>
      `).join('');
    }

    function loadUpcomingInspections(upcomingInspections) {
      const container = document.getElementById('upcoming-inspections');
      
      if (!upcomingInspections || upcomingInspections.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">No upcoming inspections</p>';
        return;
      }
      
      container.innerHTML = upcomingInspections.map(inspection => `
        <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-light rounded">
          <div>
            <div class="fw-bold">${inspection.drainage_point_name}</div>
            <small class="text-muted">${formatDate(inspection.scheduled_date)}</small>
          </div>
          <span class="badge bg-${getPriorityColor(inspection.priority)}">${inspection.priority}</span>
        </div>
      `).join('');
    }

    function loadRecentActivity(recentInspections) {
      const container = document.getElementById('recent-activity');
      
      if (!recentInspections || recentInspections.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4">No recent activity</div>';
        return;
      }
      
      container.innerHTML = recentInspections.map(inspection => `
        <div class="activity-item d-flex align-items-center">
          <div class="activity-icon activity-completed">
            <i class="fas fa-check"></i>
          </div>
          <div class="flex-grow-1">
            <div class="fw-bold">Inspection Completed</div>
            <small class="text-muted">${inspection.drainage_point_name}</small>
            <div class="text-muted small">${formatDate(inspection.scheduled_date)}</div>
          </div>
        </div>
      `).join('');
    }

    function renderInspectionsTable() {
      const tbody = document.getElementById('inspections-table-body');
      const recent = inspections.slice(0, 10);
      
      if (recent.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No inspections found</td></tr>';
        return;
      }
      
      tbody.innerHTML = recent.map(inspection => `
        <tr>
          <td>${formatDate(inspection.scheduled_date)}</td>
          <td>${inspection.drainage_point_name}</td>
          <td>${inspection.inspection_type}</td>
          <td><span class="badge bg-${getPriorityColor(inspection.priority)}">${inspection.priority}</span></td>
          <td><span class="inspection-status status-${inspection.status.toLowerCase().replace(' ', '-')}">${inspection.status}</span></td>
          <td>
            <div class="btn-group btn-group-sm">
              ${inspection.status === 'Scheduled' ? 
                `<button class="btn btn-outline-primary" onclick="startInspectionModal(${inspection.id})">
                  <i class="fas fa-play"></i>
                </button>` : ''
              }
              ${inspection.status === 'In Progress' ? 
                `<button class="btn btn-outline-success" onclick="completeInspectionModal(${inspection.id})">
                  <i class="fas fa-check"></i>
                </button>` : ''
              }
              <button class="btn btn-outline-info" onclick="viewInspection(${inspection.id})">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function populateDrainagePointsDropdown() {
      const select = document.getElementById('drainage-point');
      select.innerHTML = '<option value="">Select drainage point</option>';
      
      drainagePoints.forEach(point => {
        const option = document.createElement('option');
        option.value = point.id;
        option.textContent = point.name;
        select.appendChild(option);
      });
    }

    function initializeCharts() {
      const ctx = document.getElementById('statusChart').getContext('2d');
      
      const statusCounts = {
        Scheduled: inspections.filter(i => i.status === 'Scheduled').length,
        'In Progress': inspections.filter(i => i.status === 'In Progress').length,
        Completed: inspections.filter(i => i.status === 'Completed').length,
        Overdue: inspections.filter(i => i.status === 'Overdue').length
      };
      
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: Object.keys(statusCounts),
          datasets: [{
            data: Object.values(statusCounts),
            backgroundColor: [
              '#17a2b8',
              '#ffc107',
              '#28a745',
              '#dc3545'
            ],
            borderWidth: 0,
            hoverOffset: 10
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                padding: 20,
                usePointStyle: true
              }
            }
          }
        }
      });
    }

    // Modal functions
    function startInspectionModal(inspectionId) {
      const inspection = inspections.find(i => i.id === inspectionId);
      if (!inspection) return;
      
      document.getElementById('inspection-id').value = inspectionId;
      document.getElementById('inspection-details').innerHTML = `
        <strong>${inspection.drainage_point_name}</strong><br>
        <span class="text-muted">${inspection.inspection_type}</span><br>
        <small>Priority: ${inspection.priority}</small>
      `;
      
      new bootstrap.Modal(document.getElementById('startInspectionModal')).show();
    }

    function completeInspectionModal(inspectionId) {
      const inspection = inspections.find(i => i.id === inspectionId);
      if (!inspection) return;
      
      document.getElementById('complete-inspection-id').value = inspectionId;
      
      new bootstrap.Modal(document.getElementById('completeInspectionModal')).show();
    }

    function showAddInspectionModal() {
      // Set default date to tomorrow
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('scheduled-date').value = tomorrow.toISOString().split('T')[0];
      
      new bootstrap.Modal(document.getElementById('addInspectionModal')).show();
    }

    function showIssueReportModal() {
      new bootstrap.Modal(document.getElementById('issueReportModal')).show();
    }

    async function startInspection() {
      const inspectionId = document.getElementById('inspection-id').value;
      const notes = document.getElementById('start-notes').value;
      
      try {
        const response = await fetch('inspector-tasks.php', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'start_inspection',
            inspection_id: inspectionId,
            notes: notes
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showNotification('Inspection started successfully', 'success');
          loadDashboardData();
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        console.error('Start inspection error:', error);
        // Fallback for demo
        const inspection = inspections.find(i => i.id == inspectionId);
        if (inspection) {
          inspection.status = 'In Progress';
          showNotification('Inspection started (demo mode)', 'info');
          renderInspectionsTable();
        }
      }
      
      bootstrap.Modal.getInstance(document.getElementById('startInspectionModal')).hide();
    }

    async function completeInspection() {
      const inspectionId = document.getElementById('complete-inspection-id').value;
      const findings = document.getElementById('findings').value;
      const recommendations = document.getElementById('recommendations').value;
      const condition = document.getElementById('condition-rating').value;
      const maintenanceRequired = document.getElementById('maintenance-required').value;
      
      if (!findings.trim()) {
        showNotification('Please provide inspection findings', 'warning');
        return;
      }
      
      try {
        const response = await fetch('inspector-tasks.php', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'complete_inspection',
            inspection_id: inspectionId,
            findings: findings,
            recommendations: recommendations,
            condition_rating: condition,
            maintenance_required: maintenanceRequired,
            create_maintenance_request: document.getElementById('create-maintenance-request').checked
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showNotification('Inspection completed successfully', 'success');
          loadDashboardData();
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        console.error('Complete inspection error:', error);
        // Fallback for demo
        const inspection = inspections.find(i => i.id == inspectionId);
        if (inspection) {
          inspection.status = 'Completed';
          inspection.findings = findings;
          inspection.recommendations = recommendations;
          showNotification('Inspection completed (demo mode)', 'info');
          renderInspectionsTable();
        }
      }
      
      bootstrap.Modal.getInstance(document.getElementById('completeInspectionModal')).hide();
    }

    async function scheduleInspection() {
      const inspectionData = {
        drainage_point_id: document.getElementById('drainage-point').value,
        inspection_type: document.getElementById('inspection-type').value,
        scheduled_date: document.getElementById('scheduled-date').value,
        scheduled_time: document.getElementById('scheduled-time').value,
        priority: document.getElementById('priority').value,
        frequency: document.getElementById('frequency').value,
        description: document.getElementById('description').value
      };
      
      if (!inspectionData.drainage_point_id || !inspectionData.scheduled_date) {
        showNotification('Please fill in required fields', 'warning');
        return;
      }
      
      try {
        const response = await fetch('inspector-tasks.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'schedule_inspection',
            ...inspectionData
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showNotification('Inspection scheduled successfully', 'success');
          document.getElementById('add-inspection-form').reset();
          loadDashboardData();
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        console.error('Schedule inspection error:', error);
        showNotification('Inspection scheduled (demo mode)', 'info');
        document.getElementById('add-inspection-form').reset();
      }
      
      bootstrap.Modal.getInstance(document.getElementById('addInspectionModal')).hide();
    }

    async function submitIssueReport() {
      const reportData = {
        location: document.getElementById('issue-location').value,
        issue_type: document.getElementById('issue-type').value,
        priority: document.getElementById('issue-priority').value,
        description: document.getElementById('issue-description').value
      };
      
      if (!reportData.location || !reportData.issue_type || !reportData.description) {
        showNotification('Please fill in all required fields', 'warning');
        return;
      }
      
      try {
        const response = await fetch('inspector-tasks.php', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'submit_issue_report',
            ...reportData
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          showNotification('Issue report submitted successfully', 'success');
          document.getElementById('issue-report-form').reset();
        } else {
          throw new Error(result.message);
        }
      } catch (error) {
        console.error('Submit issue report error:', error);
        showNotification('Issue report submitted (demo mode)', 'info');
        document.getElementById('issue-report-form').reset();
      }
      
      bootstrap.Modal.getInstance(document.getElementById('issueReportModal')).hide();
    }

    function viewInspection(inspectionId) {
      const inspection = inspections.find(i => i.id === inspectionId);
      if (!inspection) return;
      
      showNotification(`Viewing inspection details for ${inspection.drainage_point_name}`, 'info');
    }

    // Utility functions
    function animateCounter(elementId, targetValue) {
      const element = document.getElementById(elementId);
      const startValue = 0;
      const duration = 1500;
      const startTime = performance.now();
      
      function updateCounter(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        const currentValue = Math.floor(startValue + (targetValue - startValue) * progress);
        
        element.textContent = currentValue;
        
        if (progress < 1) {
          requestAnimationFrame(updateCounter);
        }
      }
      
      requestAnimationFrame(updateCounter);
    }

    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString();
    }

    function getPriorityColor(priority) {
      const colors = {
        'Low': 'success',
        'Medium': 'info',
        'High': 'warning',
        'Critical': 'danger'
      };
      return colors[priority] || 'secondary';
    }

    function showTab(tabName) {
      showNotification(`Showing ${tabName} tab`, 'info');
    }

    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.className = `alert alert-${type} alert-dismissible fade show notification`;
      notification.style.cssText = `
        position: fixed; top: 100px; right: 20px; z-index: 9999; 
        max-width: 400px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      `;
      notification.innerHTML = `
        <i class="fas fa-${getNotificationIcon(type)} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      document.body.appendChild(notification);
      setTimeout(() => {
        if (notification.parentNode) notification.remove();
      }, 5000);
    }

    function getNotificationIcon(type) {
      const icons = {
        success: "check-circle",
        danger: "exclamation-triangle",
        warning: "exclamation-triangle",
        info: "info-circle",
      };
      return icons[type] || "info-circle";
    }

    // Sample data functions
    function getSampleInspections() {
      return [
        {
          id: 1,
          drainage_point_id: 1,
          drainage_point_name: 'Main Street Drain A1',
          inspection_type: 'Routine Inspection',
          scheduled_date: new Date().toISOString().split('T')[0],
          scheduled_time: '09:00',
          priority: 'Medium',
          status: 'Scheduled',
          description: 'Monthly routine inspection'
        },
        {
          id: 2,
          drainage_point_id: 2,
          drainage_point_name: 'Park Avenue Culvert',
          inspection_type: 'Safety Inspection',
          scheduled_date: new Date().toISOString().split('T')[0],
          scheduled_time: '14:00',
          priority: 'High',
          status: 'Scheduled',
          description: 'Safety inspection following report'
        },
        {
          id: 3,
          drainage_point_id: 3,
          drainage_point_name: 'Industrial Zone Pipe',
          inspection_type: 'Structural Inspection',
          scheduled_date: '2025-06-03',
          scheduled_time: '10:30',
          priority: 'Critical',
          status: 'Completed',
          description: 'Post-maintenance structural inspection',
          findings: 'Structure shows good integrity after repair',
          recommendations: 'Continue monitoring for 3 months'
        }
      ];
    }

    function getSampleDrainagePoints() {
      return [
        { id: 1, name: 'Main Street Drain A1' },
        { id: 2, name: 'Park Avenue Culvert' },
        { id: 3, name: 'Industrial Zone Pipe' },
        { id: 4, name: 'Hospital Road Drain' },
        { id: 5, name: 'School Area Culvert' }
      ];
    }
  </script>
</body>
</html>